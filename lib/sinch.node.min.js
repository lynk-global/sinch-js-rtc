function Notification(a,b,c,d){this.progress=a/b,this.message=c,this.object=d}function getBrowserInfo(){var a,b=navigator.userAgent,c=b.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||b.match(/(applewebkit(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(c[1])?(a=/\brv[ :]+(\d+)/g.exec(b)||[],"IE "+(a[1]||"")):"Chrome"===c[1]&&(a=b.match(/\bOPR\/(\d+)/),null!=a)?"Opera "+a[1]:(c=c[2]?[c[1],c[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(a=b.match(/version\/(\d+)/i))&&c.splice(1,1,a[1]),c.join("/").substring(0,50))}function getPlatformInfo(){return navigator.platform}function Sinch(a){if(!a)throw new TypeError("Could not create SinchClient, configuration not provided.");if(a.capabilities=a.capabilities||{},"string"!=typeof a.applicationKey)throw new TypeError("Could not create SinchClient, applicationKey is not a string");this.capabilities=a.capabilities,this._appKey=a.applicationKey||"",this._appSecret=a.applicationSecret||void 0,this._sessionId="",this._sessionSecret="",this._logHandler=a.onLogMessage||function(){},this._logMxpHandler=a.onLogMxpMessage||function(){},this._onlineCapability=a.startActiveConnection||a.supportActiveConnection||!1,this._autoStartMxp=a.startActiveConnection||!1,this._expiresIn=a.expiresIn||86400,this._subInstanceId=Math.round(Math.random()*Math.pow(2,32)),this._customStream=a.customStream||void 0,this._supportVideo=a.capabilities.video||!1,this._multiCall=a.capabilities.multiCall||!1,this.applicationKey=this._appKey,this.firefox=!1,"undefined"!=typeof navigator&&(this.firefox=(navigator||{userAgent:""}).userAgent.indexOf("Firefox")>0),this._url={base:"https://api.sinch.com/v1/",user:"https://userapi.sinch.com/v1/",portal:"https://portalapi.sinch.com/v1/",reporting:"https://reportingapi.sinch.com/v1/",reporting_v2:"https://reportingapi.sinch.com/v2/",calling:"https://callingapi.sinch.com/v1/",messaging:"https://messagingapi.sinch.com/v1/",verification:"https://api.sinch.com/verification/v1/"},this.setUrl(a.urlObj||{}),this.loadPAPIUrl(),this.loadTimeDelta(),this.user=new User(this),"messaging"in this.capabilities&&this.capabilities.messaging&&(this.messageClient=new MessageClient(this)),"calling"in this.capabilities&&this.capabilities.calling&&(this.callClient=new CallClient(this,a.customStream)),"stealth"in this.capabilities&&this.capabilities.stealth&&(this.callClient=new CallClient(this,a.customStream))}function Call(a,b,c){this.sinch=a,this.eventListeners=[],this.callId=c||getUuid(),this.callDomain="None",this.callOutbound=void 0,this.fromId="",this.toId="",this.sinch.firefox||(this.webRtcConfig={iceServers:[{url:"stun:23.21.150.121"},{url:"stun:stun.l.google.com:19302"}]}),this.outgoingStream=void 0,this.outgoingStreamURL=void 0,this.incomingStream=void 0,this.incomingStreamURL=void 0,this.earlymedia=void 0,this.callState=CallState.INITIATING,this.callEndCause=CallEndCause.NONE,this.timeProgressing=null,this.timeEstablished=null,this.timeEnded=null,this.error=null,this.autoAnswer=!1,this.autoHangup=!1,this.videoSupport=b||!1,this.clientMap={},this.sdpMap={},this.iceMapRx={},this.iceMapTx=[],this.activeInstance=void 0,this.pcMap={},this.dataChannels={},this.proxyUrl=void 0,this.customHeaders=void 0,this.sdpAnswerBuffer={},this.joinBuffer={};var d={onCallEnded:function(){this.sinch.mxp.unsubscribe("signalPubNub")}.bind(this)};this.addEventListener(d);var e="web",f="0";try{e=getBrowserInfo().split("/")[0],f=getBrowserInfo().split("/")[1]}catch(g){}var h={onCallEnded:function(b){var c=b.getDetails();if(c.startedTime){var d={callId:b.callId,domain:b.callDomain,outbound:b.callOutbound,fromId:b.fromId,toId:b.toId,callTime:new Date(c.startedTime).toISOString(),duration:c.duration,setupDuration:(b.timeEstablished-b.timeProgressing)/1e3||0,result:b.callEndCause,deviceInformation:{ModelId:getPlatformInfo()||"unknown",OSName:e,OSVersion:f,SDKPlatform:"js",SDKPlatformVersion:a.getVersion()}};b.sinch.callReporting(d).fail(function(){console.error("Could not report call!")})}b.ffIceTimer&&clearInterval(b.ffIceTimer)}};this.addEventListener(h)}function CallDetails(a){this.endCause=a.endCause,this.endedTime=a.endedTime,this.error=a.error,this.establishedTime=a.establishedTime,this.startedTime=a.startedTime,this.duration=a.duration}function CallClient(a,b){if(!(a instanceof Sinch))throw new Error("CallClient can't be instantiated, use getCallClient in an SinchClient instance");var c=navigator.userAgent.toLowerCase();if(c.indexOf("msie")>-1||/Apple Computer/.test(navigator.vendor))throw new Error("SinchClient can't be started with calling capability. Browser not supported.");this.sinch=a,this.eventListeners=[],this.callBuffert={},this.localMediaStream=void 0,this.incomingCallCustomStream=b,this.groupChannel=void 0}function GroupCall(a,b){this.sinch=a,this.callClient=a.callClient,this.groupChannel=b,this.eventListeners=[],this.callBuffert=[],this.callListeners={onCallProgressing:function(a){this.sinch.log(new Notification(0,1,"Call progressing",a))}.bind(this),onCallEstablished:function(a){this.sinch.log(new Notification(0,1,"Call established",a)),this.execListener("onGroupRemoteCallAdded",a)}.bind(this),onCallEnded:function(a){this.sinch.log(new Notification(0,1,"Call ended",a)),this.execListener("onGroupRemoteCallRemoved",a)}.bind(this)},this.groupListener={onIncomingCall:function(a){a.addEventListener(this.callListeners),setTimeout(function(){a.answer()},450*Object.keys(this.callBuffert).length+Math.random())}.bind(this)},this.callClient.addEventListener(this.groupListener),this.sinch.callClient.initStream().then(function(a){this.sinch.log(new Notification(0,1,"Media stream successfully created",a)),this.execListener("onGroupLocalMediaAdded",a),this.sinch.mxp.broadcastPubNub.publish({channel:b,message:this.sinch.user.userId}),this.sinch.mxp.subscribeNotificationChannel(b)}.bind(this)),this.sinch.onnotification=function(a,c){b==a&&c!=this.sinch.user.userId&&(this.sinch.log(new Notification(0,1,"Will call user in group, after random timeout",c)),setTimeout(function(){var a=this.callClient.callUser(c);this.callBuffert.push(a),a.addEventListener(this.callListeners)}.bind(this),300+Math.round(500*Math.random())))}.bind(this)}function Message(a,b){if(this.delivered=[],this.direction=!b,a instanceof MXPMessageObj){this.messageId=a.mxpSessionId;var c=JSON.parse(a.decrypted.bd);this.textBody=c.t,this.recipientIds=a.recipientIds,this.senderId=a.decrypted.fu;try{this.headers=a.decrypted.nvps.ph}catch(d){}this.timestamp=new Date}else{if(!(a instanceof Object))throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Unsupported message parameters",a);this.messageId=getUuid(),this.recipientIds=a.recipientIds,this.textBody=a.textBody,this.senderId=a.senderId,this.headers=a.publicHeaders,this.timestamp=new Date}}function MessageDeliveryInfo(a,b){this.messageId=b,this.recipientId=a,this.timestamp=new Date}function MessageClient(a){if(!(a instanceof Sinch))throw new Error("MessageClient can't be instantiated, use getMessageClient in an SinchClient instance");this.sinch=a,this.eventListeners=[],this.messageBuffert={},this.ackBuffert={},this.onMessageDelivered=[],this.emptyLog(),this.messageLogInterval=setInterval(this.commitLog.bind(this),3e4)}function SinchError(a,b,c,d){this.name="SinchError",this.domain=a||-1,this.code=b||0,this.response=d||{},this.message=c||"General sinch error",this.stack=new Error(c).stack}function User(a){this.userObj={},this.sinch=a}function Verification(a,b,c){if(!(a instanceof Sinch))throw new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationInvalidInput,"Invalid input to constructor. VerificationClient can not be instantiated, use createSmsVerification in an SinchClient instance",error);if("undefined"==typeof b||0==b.toString().length)throw new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationInvalidInput,"Invalid input to constructor. Valid phone number required (E.164 format ideally)",b);this.sinch=a,this.number=b||null,this.custom=c||null,this.flagVerified=!1}function MXP(a){this.sinch=a,this.user=a.user,this.rtcConfiguration=a.user.mxpConfig.rtcConfiguration,this.rtcProfile=a.user.mxpConfig.rtcProfile,PUBNUB.offline(),this.broadcastPubNub=PUBNUB({publish_key:this.rtcConfiguration.broadcastNetwork.publishKey,subscribe_key:this.rtcConfiguration.broadcastNetwork.subscribeKey,ssl:!0,origin:this.rtcConfiguration.broadcastNetwork.host}),this.signalPubNub=PUBNUB({publish_key:this.rtcConfiguration.signalNetwork.publishKey,subscribe_key:this.rtcConfiguration.signalNetwork.subscribeKey,ssl:!0,origin:this.rtcConfiguration.signalNetwork.host}),this.messageBuffert={},this.transportBuffert={},this.sessionBuffert={},this.unencryptedFrames={},this.broadcastPubNub.sinchStack={},this.broadcastPubNub.sinchStack[this.rtcProfile.broadcastChannel]=[],this.broadcastPubNub.sinchStack[this.rtcProfile.transportChannel]=[],this.signalPubNub.sinchStack={},this.signalPubNub.sinchStack[this.rtcProfile.signalChannel]=[]}function MXPError(a,b,c,d){this.name="MXPError",this.domain=a||-1,this.code=b||0,this.response=d||{},this.message=c||"General MXP error",this.stack=new Error(c).stack}function MXPLog(a,b){this.message=a,this.object=b}function MXPIncoming(a,b){this.handler=a,this.object=b}function MXPOutgoing(a,b){this.handler=a,this.object=b}function MXPMessageObj(a,b){this.decrypted={};for(var c in a)if("object"==typeof a[c]){this[c]=a[c]instanceof Array?[]:{};for(var d in a[c])this[c][d]=a[c][d]}else this[c]=a[c];if(b instanceof Call){b.activeInstance&&(this.decrypted.nvps=this.decrypted.nvps||{},this.decrypted.nvps.to=b.activeInstance),this.txChannels=[];for(var e in b.clientMap)"virtual"!=e&&-1===this.txChannels.indexOf(b.clientMap[e].fs)&&this.txChannels.push(b.clientMap[e].fs);0==this.txChannels.length&&"virtual"in b.clientMap&&this.txChannels.push(b.clientMap.virtual.fs),this.sub="signalPubNub"}}function MXPCryptError(a,b,c,d){this.name="MXPError",this.domain=a||-1,this.code=b||0,this.response=d||{},this.message=c||"General MXP error",this.stack=new Error(c).stack}var PUBNUB=require("pubnub").init({}),XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest,window=window||global,WRTC=require("wrtc"),navigator=navigator||{getUserMedia:function(){return!1},userAgent:""},btoa=require("btoa"),atob=require("atob"),localStorage=require("localStorage"),SinchTicketGenerator=require("sinch-ticketgen"),Q=require("q"),SinchVersion=require("../VERSION"),SinchTicketGenerator=require("sinch-ticketgen"),ErrorDomain={ErrorDomainNone:-1,ErrorDomainNetwork:0,ErrorDomainCapability:1,ErrorDomainSession:2,ErrorDomainApi:3,ErrorDomainOther:4,ErrorDomainSDK:5,ErrorDomainVerification:7},ErrorCode={NoneNone:0,NetworkConnectionRefused:1e3,NetworkConnectionTimedOut:1001,NetworkServerError:1002,CapabilityUserNotFound:2e3,CapabilityCapabilityMissing:2001,CapabilityAuthenticationFailed:2002,SessionFailedToInitiateSession:3e3,SessionNoPendingSessionExists:3001,SessionTransferCantBeInitiated:3002,SessionActiveUserLimitReached:3003,ApiApiCallFailed:4e3,OtherInvalidOfflinePayloadTooBig:5e3,OtherInvalidOfflineInvitePayloadFailedToDecode:5001,OtherInvalidOfflineInviteUnknownType:5002,OtherOther:5003,SDKUnexpectedCall:6e3,SDKInternalError:6001,SDKInternalOther:6002,SDKMissingParameter:6003,SDKMissingCallback:6004,VerificationInvalidInput:7001,VerificationServiceError:7002,VerificationIncorrectCode:7003,VerificationFailedToInterceptCode:7004,VerificationUnexpectedInitiateError:7005},sinchAjax=function(a){var b=Q.defer(),c=new XMLHttpRequest;c.onload=function(){if(c.status>=200&&c.status<300){try{c.response=c.response||c.responseText,c.data=JSON.parse(c.response||"{}")}catch(a){console.log("Cant parse JSON"+c.response)}b.resolve(c.data)}else{try{c.response=c.response||c.responseText,c.data=JSON.parse(c.response||"{}")}catch(a){console.log("Cant parse JSON"+c.response)}b.reject(c)}},c.onerror=function(){b.reject(new Error("Unsupported operation "+c.status,c))},c.open(a.method,a.url,!0);for(var d in a.headers)c.setRequestHeader(d,a.headers[d]);return c.send(JSON.stringify(a.data)),b.promise},requestPrototype=function(a,b){var c={method:a.method,headers:{"Content-Type":"application/json; charset=UTF-8",Accept:"application/json, text/plain, */*"}};"GET"!=a.method&&(c.data=b),c.url="";for(var d in a.urlParts){if(":"===a.urlParts[d][0]){var e=a.urlParts[d].slice(1);c.url+=encodeURIComponent((b||{})[e]).replace(/%2B/g,"+").replace(/%40/g,"@")}else c.url+=a.urlParts[d];d<a.urlParts.length-1&&(c.url+="/")}switch(a.auth){case"sign":c.headers=this.signSession(c);break;case"nosign":c.headers=this.signApp(c);break;case"ticket":c.headers=this.signTicket(c),delete c.data.authorization;break;case"signorticket":this._sessionId?c.headers=this.signSession(c):(c.headers=this.signTicket(c),delete c.data.authorization);break;default:throw new Error("Unsupported authentication type: "+a.auth)}if("GET"===a.method&&b&&Object.keys(b).length>0){c.url+="?";for(var f in b)c.url+=encodeURIComponent(f)+"="+encodeURIComponent(b[f])+"&"}return sinchAjax(c)},getUuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},PAPI=PAPI||{};PAPI.base={getServerTime:{url:"timestamp/",method:"GET",auth:"nosign"},getInstance:{url:"instance",method:"POST",auth:"ticket"},renewInstance:{url:"instance",method:"POST",auth:"sign"},renewSecret:{url:"instances/id/:instanceId/authorization",method:"PUT",auth:"ticket"},getInstances:{url:"instances/id/",method:"GET",auth:"sign"}};var PAPI=PAPI||{};PAPI.calling={getConfiguration:{url:"configuration/user",method:"GET",auth:"sign"},placeCall:{url:"calls/:domain",method:"POST",auth:"sign"},callReporting:{url:"calls/:domain/id/:callId",method:"PUT",auth:"sign"},postMedia:{url:"media",method:"POST",auth:"sign"}};var PAPI=PAPI||{};PAPI.messaging={getTransportById:{url:"transport",method:"GET",auth:"sign"},getTransportByParticipants:{url:"transport",method:"POST",auth:"sign"},messageReporting:{url:"report/im",method:"POST",auth:"sign"},pushMessage:{url:"push/messages",method:"POST",auth:"sign"}};var PAPI=PAPI||{};PAPI.user={authenticate:{url:"users/email/:email/authentication",method:"POST",auth:"nosign"},authenticateUsername:{url:"users/username/:username/authentication",method:"POST",auth:"nosign"},authenticateNumber:{url:"users/number/:number/authentication",method:"POST",auth:"nosign"},createUser:{url:"users",method:"POST",auth:"nosign"},changePassword:{url:"user/password",method:"PUT",auth:"sign"},updateUser:{url:"user/profile",method:"PATCH",auth:"sign"},getUserProfile:{url:"user/profile",method:"GET",auth:"sign"}};var PAPI=PAPI||{};PAPI.verification={verifyUserSMS:{url:"verifications",method:"POST",auth:"sign"},confirmUserSMS:{url:"verifications/number/:number",method:"PUT",auth:"sign"}},Sinch.prototype.loadPAPIUrl=function(){this.PAPI=JSON.parse(JSON.stringify(PAPI));for(var a in PAPI)for(var b in PAPI[a])this.PAPI[a][b].urlParts=(this._url[a]+this.PAPI[a][b].url).split("/"),this[b]=requestPrototype.bind(this,this.PAPI[a][b])},Sinch.prototype.loadTimeDelta=function(){var a=Q.defer();return this.timeDelta?a.resolve():this.getServerTime().then(function(b){var c=new Date(b.timestamp),d=new Date;this.timeDelta=c-d,a.resolve()}.bind(this)).catch(function(b){console.error(b),a.fail(b)}),a.promise},Sinch.prototype.config=function(a){this._appKey=a.appKey||this._appKey,this._sessionId=a.sessionId||this._sessionId,this._sessionSecret=a.sessionSecret||this._sessionSecret,localStorage["SinchSDK-"+this._appKey+"-"+this.user.userId]=this._sessionId},Sinch.prototype.loadSessionId=function(){this._sessionId=localStorage["SinchSDK-"+this._appKey+"-"+this.user.userId]||""},Sinch.prototype.log=function(a,b){b&&b.notify(a),this._logHandler(a)},Sinch.prototype.logMxp=function(a){this._logMxpHandler(a)},Sinch.prototype.setUrl=function(a){this._url.user=a.user||this._url.user,this._url.base=a.base||this._url.base,this._url.portal=a.portal||this._url.portal,this._url.reporting=a.reporting||this._url.reporting,this._url.reporting_v2=a.reporting_v2||this._url.reporting_v2,this._url.calling=a.calling||this._url.calling,this._url.messaging=a.messaging||this._url.messaging,this._url.verification=a.verification||this._url.verification,this.loadPAPIUrl()},Sinch.prototype.terminate=function(){try{this.mxp&&this.mxp.close(),this.mxp.destroy(),this.mxp&&delete this.mxp,this._sessionId="",this._sessionSecret="",this.messageClient&&this.messageClient.destroy()}catch(a){}},Sinch.prototype.stop=function(){console.error("Stop is deprecated, use terminate() instead!"),this.terminate()},Sinch.prototype.adjustedTime=function(){var a=(new Date).getTime();return new Date(a+(this.timeDelta||0)).toISOString()},Sinch.prototype.signSession=function(a){try{var b="";if(void 0!==a.data){var c="string"!=typeof a.data?JSON.stringify(a.data):a.data;b=CryptoJS.MD5(c).toString(CryptoJS.enc.Base64)}a.headers["Content-Type"]=(a.headers["Content-Type"]||"").replace("utf-8","UTF-8").replace("/json;chars","/json; chars"),a.headers["X-Timestamp"]=a.headers["X-Timestamp"]||this.adjustedTime();var d=""+a.method+"\n"+b+"\n"+(a.headers["Content-Type"]||"")+"\nx-timestamp:"+a.headers["X-Timestamp"]+"\n"+a.url.match(/^https?:\/\/[^\/]+([^#]*)/)[1];if(this._sessionId.length>0&&this._sessionSecret.length>0){var e=CryptoJS.HmacSHA256(CryptoJS.enc.Utf8.parse(d),CryptoJS.enc.Base64.parse(this._sessionSecret)).toString(CryptoJS.enc.Base64);a.headers.Authorization="instance "+this._sessionId+":"+e}else a.headers.Authorization="application "+this._appKey;return a.headers}catch(f){throw f}return null},Sinch.prototype.signTicket=function(a,b){return b=b||a.data.authorization,a.headers=a.headers||{},a.headers.Authorization="user "+b,a.headers["X-Timestamp"]=this.adjustedTime(),a.headers},Sinch.prototype.signApp=function(a){try{return a.headers["X-Timestamp"]=a.headers["X-Timestamp"]||this.adjustedTime(),a.headers.Authorization="application "+this._appKey,a.headers}catch(b){throw b}return null},Sinch.prototype.getSession=function(){return{userId:this.user.userId,sessionId:this._sessionId,sessionSecret:this._sessionSecret}},Sinch.prototype.newUser=function(a,b,c){var d=Q.defer();return b=b||function(a){return console.info("User successfully created"),a},c=c||function(a){console.error(a)},this.user.create(a).then(b).then(d.resolve).fail(function(a){this.log(a),c(a),d.reject(a)}.bind(this)),d.promise},Sinch.prototype.start=function(a,b,c){var d=Q.defer();if(b=b||function(){this.log(new Notification(0,1,"SinchClient started"))}.bind(this),c=c||function(a){console.error(a)},this.started){var e=new Error("Sinch client already started");c(e),d.reject(e)}else this.started=!0,this.loadTimeDelta().then(function(a){return this.log(new Notification(0,5,"Get authentication token"),d),this.user.authenticate(a)}.bind(this,a),a).then(function(a){return this.loadSessionId(),a}.bind(this)).then(function(a){return this.log(new Notification(1,5,"Get instance using auth token"),d),a&&a.sessionId&&a.sessionSecret?this.user.resumeSession(a):this.user.initSessKeySecret()}.bind(this)).fail(function(a){if(40400===((a||{response:{}}).response||{}).errorCode)return this.log(new Notification(1,5,"Invalid instance. Will try again without any pre-set instance ID."),d),this._sessionId="",this.user.initSessKeySecret();throw a}.bind(this)).then(function(){return this.log(new Notification(2,5,"Get MXP configuration"),d),this.user.getMXPConf()}.bind(this)).then(function(){this.log(new Notification(3,5,"Create MXP object"),d),this.mxp=new MXP(this)}.bind(this)).then(function(){return!this._autoStartMxp||"undefined"==typeof this.messageClient&&"undefined"==typeof this.callClient?void this.log(new Notification(4,5,"Will NOT start active connection. This will prevent IM and incoming data calls."),d):(this.log(new Notification(4,5,"Will start active connection"),d),this.startActiveConnection())}.bind(this)).then(b).then(function(){this.log(new Notification(5,5,"Successfully started SinchClient"),d),d.resolve()}.bind(this)).fail(function(a){this.started=!1,this._sessionId="",this._sessionSecret="",this.log(a),c(a),d.reject(a)}.bind(this));return d.promise},Sinch.prototype.getMessageClient=function(){if("messaging"in this.capabilities&&this.capabilities.messaging)return this.messageClient;throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"No messaging capability, not possible to retrieve messageClient")},Sinch.prototype.getCallClient=function(){if("calling"in this.capabilities&&this.capabilities.calling)return this.callClient;throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"No calling capability, not possible to retrieve callClient")},Sinch.prototype.createSmsVerification=function(a,b){return new Verification(this,a,b)},Sinch.prototype.startActiveConnection=function(){if(this._onlineCapability&&this.started)return this.log(new Notification(4,5,"Manually starting active connection")),this.mxp.init();if(!this._onlineCapability)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,'No online capability, can not start active connection. Set configuration option "supportActiveConnection" to "true" when instantiating the SinchClient');this._autoStartMxp=!0},Sinch.prototype.stopActiveConnection=function(){if(this._onlineCapability)return this.log(new Notification(4,5,"Manually closing active connection")),this.mxp.close();throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,'No online capability, can not start active connection. Set configuration option "supportActiveConnection" to "true" when instantiating the SinchClient')},Sinch.prototype.getVersion=function(){try{return SinchVersion.version[1]}catch(a){return"dev"}},Sinch.prototype.onnotification=function(){};var SinchClient=Sinch,PeerConnection,SessionDescription,IceCandidate,WRTC=WRTC||{};PeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection||WRTC.RTCPeerConnection,SessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription||WRTC.RTCSessionDescription,IceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate||WRTC.RTCIceCandidate,Call.prototype.addEventListener=function(a){this.eventListeners.push(a)},Call.prototype.removeEventListener=function(a){this.eventListeners.splice(this.eventListeners.indexOf(a),1)},Call.prototype.setStream=function(a){this.outgoingStream=a,this.outgoingStreamURL=window.URL.createObjectURL(a)},Call.prototype.execListener=function(a,b){this.eventListeners.forEach(function(c){try{return c[a]&&c[a](this,b)}catch(d){var e=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error executing listener: "+a,d);throw console.error(e),e}}.bind(this))},Call.prototype.setEndCause=function(a){this.callEndCause===CallEndCause.NONE&&(this.callEndCause=a)},Call.prototype.setParticipants=function(a,b){this.callOutbound=a==this.sinch.user.userId,this.toId=b,this.fromId=a},Call.prototype.progress=function(a){if(this.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"Progress: Invalid call state for progressing",Call);this.sinch.log(new Notification(0,1,"Call changing state to PROGRESSING")),this.timeProgressing=new Date,this.callState=CallState.PROGRESSING,a&&this.execListener("onCallProgressing"),this.autoAnswer&&this.answer(),this.autoHangup&&this.hangup()},Call.prototype.establish=function(){if(this.callState==CallState.PROGRESSING){this.sinch.log(new Notification(0,1,"Call changing state to ESTABLISHED")),this.pc=this.pc||this.pcMap[this.activeInstance]||this.pcMap.virtual,delete this.pcMap.virtual;for(var a in this.pcMap)a!=this.activeInstance&&this.pcMap[a]!=this.pcMap[this.activeInstance]&&(this.pcMap[a]&&"closed"!=this.pcMap[a].signalingState&&this.pcMap[a].close(),delete this.pcMap[a]);"connection"!=this.callDomain&&(this.unmute(),this.incomingStream=this.pc.getRemoteStreams()[0],this.incomingStreamURL=window.URL.createObjectURL(this.incomingStream)),this.timeEstablished=new Date,this.callState=CallState.ESTABLISHED,this.execListener("onCallEstablished")}else console.log("Call state not in PROGRESSING, cant process second JOIN")},Call.prototype.mxpAck=function(a){if(this.sinch.log(new Notification(0,1,"Call ACK Received",a)),this.callState!=CallState.INITIATING&&this.callState!=CallState.PROGRESSING)throw new SinchError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"Invalid call state for processing Ack",Call);this.clientMap[a.getSenderId()]=this.clientMap[a.getSenderId()]||a.getFrom();for(var b=0;b<this.iceMapTx.length;b++){var c=this.iceMapTx[b];this.sinch.log(new Notification(0,1,"Firefox special: Transmitting buffered ICE candidates for the one Peer Connection we have.",c)),this.sinch.mxp.callTxICECandidate(this,c,a.fi).fail(function(){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending ICE candidate")})}"sdp"===a.decrypted.bt?this.processRTCAnswer(a).then(function(){"yes"===(a.decrypted.nvps||{}).earlymedia?(this.activeInstance=a.getSenderId(),this.progress(!1),this.establish(),this.earlymedia=!0):this.progress(!0),this.joinBuffer[a.getSenderId()]&&(this.sinch.log(new Notification(0,1,"Buffered JOIN was detected for this Ack, will immediatley process & remove.")),this.mxpJoin(this.joinBuffer[a.getSenderId()]),delete this.joinBuffer[a.getSenderId()])}.bind(this)):this.callState==CallState.INITIATING&&this.progress(!0)},Call.prototype.intProcessAnswer=function(a,b){var c=Q.defer();this.sinch.log(new Notification(2,2,"Will configure SDP Answer",a));var d=this.pcMap[b];return d.setRemoteDescription(a,function(){this.sinch.log(new Notification(2,2,"Configured incoming SDP Answer",a)),c.resolve()}.bind(this),function(a){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error setting remote SDP",a)}.bind(this)),c.promise},Call.prototype.processRTCAnswer=function(a){var b=Q.defer();if(this.callState!=CallState.ENDED){var c=a.decrypted.bd;this.sinch.log(new Notification(0,2,"Processing SDP Answer from B",c));var d=new SessionDescription(JSON.parse(c));if(this.sinch.firefox)this.pcMap[a.getSenderId()]=this.offerGeneratorPC,this.sdpAnswerBuffer[a.getSenderId()]=d,b.resolve();else{this.pcMap[a.getSenderId()]=this.pcMap[a.getSenderId()]||this.initPC();var e=this.pcMap[a.getSenderId()];e.createOffer(function(){e.setLocalDescription(this.outgoingOffer,function(){this.sinch.log(new Notification(1,2,"Configured cached outgoing SDP Offer",this.outgoingOffer)),this.intProcessAnswer(d,a.getSenderId()).then(function(){b.resolve()})}.bind(this),function(a){console.error("Error setting local Description, message: "+a)})}.bind(this),function(a){console.error("Error creating offer, message: "+a)},{offerToReceiveAudio:!0,offerToReceiveVideo:this.videoSupport})}}else b.resolve();return b.promise},Call.prototype.mxpPeerEventSdp=function(a){if(this.callState==CallState.INITIATING||this.callState==CallState.PROGRESSING)this.disableIce=!0,this.processRTCAnswer(a);else if(this.callState==CallState.ESTABLISHED){var b=JSON.parse(a.decrypted.bd);if("offer"==b.type){this.sinch.log(new Notification(0,3,"Got renegotiation SDP Offer",b));var c=new SessionDescription(b);this.pc.setRemoteDescription(c,function(){this.sinch.log(new Notification(1,3,"Successfully configured SDP Offer.",b)),this.pc.createAnswer(function(b){this.pc.setLocalDescription(b,function(){this.sinch.log(new Notification(2,3,"Successfully created SDP Answer.",b)),this.sinch.mxp.callTxPeerEventSDP(this,b,a.getSenderId()).fail(function(){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending SDP Answer")})}.bind(this),function(a){console.error("Major error in setting local description",a)})}.bind(this),function(a){console.error("Major error in creating answer",a)})}.bind(this),function(a){throw setTimeout(function(){this.setEndCause(CallEndCause.FAILURE),this.error=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,a),this.sinch.mxp.callCancel(this).fail(function(){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Cancel")}),this.callFailure()}.bind(this),2e3),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error setting remote SDP")}.bind(this))}else if("answer"==b.type){this.sinch.log(new Notification(0,2,"Got renegotiation SDP Answer",b));var c=new SessionDescription(b);this.pc.setRemoteDescription(c,function(){this.sinch.log(new Notification(1,2,"Configured incoming SDP Answer",b))}.bind(this),function(a){throw setTimeout(function(){this.setEndCause(CallEndCause.FAILURE),this.error=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,a),this.sinch.mxpCancel(this).fail(function(){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Cancel")}),this.callFailure()}.bind(this),2e3),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error setting remote SDP")})}}},Call.prototype.mxpInjectIce=function(a){if(this.callState!=CallState.ENDED){this.sinch.log(new Notification(0,2,"Recieved ICE Candidate offer from B",a));var b=JSON.parse(a.decrypted.bd);b.candidate=b.cand||b.candidate,b.sdpMLineIndex=b.sdpMLI||b.sdpMLineIndex;var c=a.getSenderId();!this.sinch.firefox&&c in this.pcMap?(this.sinch.log(new Notification(0,2,"Injecting ICE candidate directly",b)),this.injectIce(c,b)):(this.sinch.log(new Notification(0,2,"Buffering ICE candidate until PeerConnection created",b)),this.iceMapRx[c]=this.iceMapRx[c]||[],this.iceMapRx[c].push(b))}},Call.prototype.injectIce=function(a,b){var c=b.candidate.split(" ");if(-1!=c.indexOf("srflx")&&"udp"==c[2].toLowerCase()){var d=["candidate:"+(123+(this.pcMap[a].proxyIce||[]).length),c[1],c[2].toUpperCase(),Math.round(c[3]/10),this.proxyUrl.split("/")[3].split(":")[0],this.proxyUrl.split("/")[3].split(":")[1],"typ","relay","raddr",c[4],"rport",c[5],"generation",0],e={candidate:d.join(" "),sdpMLineIndex:"number"==typeof b.sdpMLI?b.sdpMLI:b.sdpMLineIndex||0,sdpMid:b.sdpMid};this.sinch.log(new Notification(0,1,"Generated extra candidate for Proxy Relay",e)),"undefined"==typeof this.pcMap[a].proxyIce&&(this.pcMap[a].proxyIce=[]),this.pcMap[a].proxyIce.push(new IceCandidate(e))}this.pcMap[a].addIceCandidate(new IceCandidate(b),function(){},function(){})},Call.prototype.mxpJoin=function(a){if(this.sinch.log(new Notification(0,1,"Call JOIN Received",a)),this.activeInstance&&this.activeInstance!=a.getSenderId())throw console.error("Can not process JOIN, call in session after previous JOIN"),new SinchError(ErrorDomain.ErrorDomainSession,ErrorCode.SessionActiveUserLimitReached,"Can not process JOIN, call in session after previous JOIN");var b=a.getSenderId();this.callState==CallState.INITIATING?(this.sinch.log(new Notification(0,1,"JOIN received before ACK. Will cache JOIN to process after ACK.")),this.joinBuffer[b]=a):Q.fcall(function(){var c=Q.defer();if(this.sinch.firefox&&this.sdpAnswerBuffer[b]){var d=this.sdpAnswerBuffer[b];this.intProcessAnswer(d,a.getSenderId()).then(function(){for(;(this.iceMapRx[b]||[]).length;){var d=this.iceMapRx[b].pop();this.injectIce(a.getSenderId(),d),this.sinch.log(new Notification(0,1,"Injected ice from Ice Rx buffert",d))}setTimeout(function(){c.resolve()}.bind(this),200)}.bind(this))}else c.resolve();return c.promise}.bind(this)).then(function(){if(0==((this.pcMap[b]||{}).proxyIce||[]).length)if(console.error("Warning, no proxy configured (1). Will try to add candidate without srflx reference",this.pcMap[b]),this.proxyUrl){var c=this.proxyUrl.split("/")[3].split(":");this.pcMap[b].proxyIce=this.pcMap[b].proxyIce||[],this.pcMap[b].proxyIce.push(new IceCandidate({sdpMid:"audio",sdpMLI:0,sdpMLineIndex:0,candidate:CallHelper.generateIceCandidate(c[0],c[1])}))}else console.error("Warning, no proxyUrl configured!");if(((this.pcMap[b]||{}).proxyIce||[]).forEach(function(a){this.sinch.log(new Notification(0,1,"Adding buffered proxy ICE candidate",a)),this.pcMap[b].addIceCandidate(a,function(){this.sinch.log(new Notification(0,1,"Successfully added proxy ICE candidate",a))
}.bind(this),function(a){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Failed to add proxy ICE candidate when processing JOIN",a)})}.bind(this)),this.callState!=CallState.PROGRESSING&&!this.earlymedia)throw console.error("Can not process JOIN, call in unexpected state. Call state: "+this.getState()),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Can not process JOIN, call in unexpected state.");this.activeInstance=a.getSenderId(),this.sinch.mxp.callJoined(this).then(function(){this.sinch.log(new Notification(0,1,"Successfully sent JOINED",this)),this.earlymedia||this.establish()}.bind(this)).fail(function(a){console.error("Unhandled error in call.mxpJoin.",a)})}.bind(this)).fail(function(a){console.error("Error processing JOIN",a)})},Call.prototype.mxpJoined=function(a){if(this.sinch.log(new Notification(0,1,"Call JOINED Received",a)),this.callState==CallState.INITIATING||this.callState==CallState.PROGRESSING){var b=JSON.parse(a.decrypted.bd);if(b.fi!=this.sinch._sessionId+":"+this.sinch._subInstanceId)this.setEndCause(CallEndCause.OTHER_DEVICE_ANSWERED),this.mxpHangup();else if(this.callState==CallState.PROGRESSING){var c=a.getSenderId();if(this.sinch.firefox)for(;(this.iceMapRx[c]||[]).length;){var d=this.iceMapRx[c].pop();this.injectIce(a.getSenderId(),d),this.sinch.log(new Notification(0,1,"Injected ice from Ice Rx buffert",d))}if(0==((this.pcMap[c]||{}).proxyIce||[]).length)if(console.error("Warning, no proxy configured (2). Will try to add candidate without srflx reference",this.pcMap[c]),this.proxyUrl){var e=this.proxyUrl.split("/")[3].split(":");this.pcMap[c].proxyIce=this.pcMap[c].proxyIce||[],this.pcMap[c].proxyIce.push(new IceCandidate({sdpMid:"audio",sdpMLI:0,sdpMLineIndex:0,candidate:CallHelper.generateIceCandidate(e[0],e[1])}))}else console.error("Warning, no proxyUrl configured!");((this.pcMap[c]||{}).proxyIce||[]).forEach(function(a){this.sinch.log(new Notification(0,1,"Adding buffered proxy ICE candidate",a)),this.pcMap[c].addIceCandidate(a,function(){this.sinch.log(new Notification(0,1,"Successfully added proxy ICE candidate",a))}.bind(this),function(a){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Failed to add proxy ICE candidate when processing JOINED",a)})}.bind(this)),this.establish()}}else console.log("Call state already ESTABLISHED (or ENDED), cant process second JOIN")},Call.prototype.mxpHangup=function(a){if(this.callState!=CallState.ENDED){this.sinch.log(new Notification(0,1,"Call HANGUP Received",a)),this.setEndCause(this.callState==CallState.ESTABLISHED?CallEndCause.HUNG_UP:CallEndCause.CANCELED),this.timeEnded=new Date,this.callState=CallState.ENDED,this.execListener("onCallEnded"),this.pc&&"closed"!=this.pc.signalingState&&this.pc.close(),delete this.pc;for(var b in this.pcMap)delete this.pcMap[b]}},Call.prototype.mxpDeny=function(a){this.callState!=CallState.ENDED&&(this.sinch.log(new Notification(0,1,"Call DENIED Received",a)),this.setEndCause(CallEndCause.DENIED),this.callState==CallState.INITIATING?(this.autoHangup=!0,this.progress(!0)):this.hangup())},Call.prototype.mxpCancel=function(a){if(this.callState!=CallState.ENDED){this.sinch.log(new Notification(0,1,"Call CANCEL Received",a)),this.timeEnded=new Date,this.callState=CallState.ENDED;{Date.now()}this.setEndCause(CallEndCause.CANCELED),this.execListener("onCallEnded"),this.pc&&"closed"!=this.pc.signalingState&&this.pc.close(),delete this.pc;for(var b in this.pcMap)delete this.pcMap[b]}},Call.prototype.mxpFail=function(a){this.sinch.log(new Notification(0,1,"Call FAILURE Received",a)),"message"==a.decrypted.bt&&(this.error=new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,""),this.error.message=a.decrypted.bd,this.error.mxp=a.decrypted),this.callFailure()},Call.prototype.callFailure=function(){this.timeEnded=new Date,this.callState=CallState.ENDED,this.setEndCause(CallEndCause.FAILURE),this.execListener("onCallEnded"),this.pc&&"closed"!=this.pc.signalingState&&this.pc.close(),delete this.pc;for(var a in this.pcMap)delete this.pcMap[a]},Call.prototype.addEventListenerPrototype=function(a){a.onOpen&&(this.onopen=a.onOpen),a.onClose&&(this.onclose=a.onClose),a.onMessage&&(this.onmessage=a.onMessage)},Call.prototype.initPC=function(){var a=new PeerConnection(this.webRtcConfig,{optional:[{DtlsSrtpKeyAgreement:!0}]});return this.outgoingStream&&"connection"!=this.callDomain?(this.mute(),a.addStream(this.outgoingStream)):(this.sinch.log(new Notification(0,1,"WebRTC: Will add data channel before ICE negotiation")),this.dataChannels[this.sinch.user.userId]=a.createDataChannel(this.sinch.user.userId,{reliable:!1}),this.dataChannels[this.sinch.user.userId].onmessage=function(a){console.log("fallback",a)},this.dataChannels[this.sinch.user.userId].addEventListener=this.addEventListenerPrototype.bind(this.dataChannels[this.sinch.user.userId])),a.onaddstream=function(){}.bind(this),a.ondatachannel=function(a){this.sinch.log(new Notification(0,1,"WebRTC: Datachannel opened",a));try{this.dataChannels[a.channel.label]=a.channel,this.dataChannels[a.channel.label].addEventListener=this.addEventListenerPrototype.bind(this.dataChannels[a.channel.label]),this.execListener("onDataChannelAdded",this.dataChannels[a.channel.label])}catch(b){console.error("Error handling datachannel",b)}}.bind(this),a.oniceconnectionstatechange=function(a){this.sinch.log(new Notification(0,1,"WebRTC: Connection state changed",a)),this.renegotiate||!a.currentTarget||"failed"!=a.currentTarget.iceConnectionState&&"disconnected"!=a.currentTarget.iceConnectionState||(this.sinch.log(new SinchError(ErrorDomain.ErrorDomainNetwork,ErrorCode.NetworkConnectionTimedOut,"Ice connection failed. Hanging up call!",a)),this.hangup())}.bind(this),a.onicecandidate=function(b){if(!this.renegotiate&&b.candidate){this.sinch.log(new Notification(0,2,"Preparing ICE candidate for B",b.candidate));var c=Object.keys(this.pcMap).filter(function(b){return this.pcMap[b]===a}.bind(this))[0],d={cand:b.candidate.candidate,candidate:b.candidate.candidate,sdpMLI:b.candidate.sdpMLineIndex,sdpMLineIndex:b.candidate.sdpMLineIndex,sdpMid:b.candidate.sdpMid||""};setTimeout(function(){c?this.disableIce?this.sinch.log(new Notification(1,2,"ICE Disabled, will not send any ICE candidates (will be sent in different way)",d)):(this.sinch.log(new Notification(1,2,"Instantly sending ICE candidate for B",d)),this.sinch.mxp.callTxICECandidate(this,d,c).fail(function(){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending ICE candidate")})):this.iceMapTx.push(d)}.bind(this),this.sinch.mxp.sessionBuffert[this.callId]?0:500)}}.bind(this),a.onnegotiationneeded=function(b){this.callState==CallState.ESTABLISHED&&(this.renegotiate=!0,this.sinch.log(new Notification(0,2,"Negotiation needed, will generate new offer",b)),a.createOffer(function(b){this.sinch.log(new Notification(1,2,"Negotiation needed, offer generated",b)),a.setLocalDescription(b,function(){this.sinch.log(new Notification(1,2,"Negotiation needed, sending offer to recipient",b)),this.sinch.mxp.callTxPeerEventSDP(this,b,this.activeInstance).fail(function(){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending SDP Offer")})}.bind(this))}.bind(this)))}.bind(this),a.onremovestream=function(a){this.sinch.log(new Notification(0,1,"WebRTC: Stream removed",a))}.bind(this),a.onsignalingstatechange=function(a){this.sinch.log(new Notification(0,1,"WebRTC: Signaling state change",a))}.bind(this),a.onidentityresult=function(a){this.sinch.log(new Notification(0,1,"WebRTC: onidentityresult event detected",a))},a.onidpassertionerror=function(a){this.sinch.log(new Notification(0,1,"WebRTC: onidpassertionerror event detected",a))},a.onidpvalidationerror=function(a){this.sinch.log(new Notification(0,1,"WebRTC: onidpvalidationerror event detected",a))},a.onpeeridentity=function(a){this.sinch.log(new Notification(0,1,"WebRTC: onpeeridentity event detected",a))},a},Call.prototype.placeCall=function(a,b){var c=Q.defer();this.callDomain=b,this.setParticipants(this.sinch.user.userId,a),setTimeout(function(){this.callState==CallState.INITIATING&&(this.sinch.log(new Notification(0,1,"Call PROGRESSING timeout. Will hangup call.",this)),this.setEndCause(CallEndCause.TIMEOUT),this.hangup())}.bind(this),TIMEOUT_CALLPROGRESSING),setTimeout(function(){this.callState==CallState.PROGRESSING&&(this.sinch.log(new Notification(0,1,"Call ESTABLISHED timeout. Will hangup call.",this)),this.setEndCause(CallEndCause.NO_ANSWER),this.hangup())}.bind(this),TIMEOUT_CALLESTABLISHED);var d={pstn:"number",data:"username",conference:"username",connection:"username"},e={pstn:"pstn",data:"data",conference:"conference",connection:"data"},f={cli:"",destination:{type:d[b],endpoint:a},callId:this.callId,mediaChannels:["audio"],subinstanceId:this.sinch._subInstanceId,headers:{p2p:"yes"},domain:e[b]};this.sinch._supportVideo&&f.mediaChannels.push("video"),this.customHeaders&&(f.headers.ph=JSON.stringify(this.customHeaders)),"connection"==b&&(f.headers.nomedia=!0);var g=this.initPC();return g.createOffer(function(b){this.outgoingOffer=b,f.sdp=b,this.sinch.placeCall(f).then(function(d){this.sinch.log(new Notification(0,1,"Successfully initiated call, waiting for MXP signalling.",d)),void 0!==d.SignalChannel&&null!==d.SignalChannel&&(this.clientMap.virtual={fs:d.SignalChannel,fu:a}),this.proxyUrl=d.Body.replace(/(\r\n|\n|\r)/gm,""),this.sinch.firefox&&(this.offerGeneratorPC=g,g.setLocalDescription(b,function(){this.sinch.log(new Notification(0,1,"Firefox special: Configuring the local description to gather ICE candidates.",b))}.bind(this),function(a){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Firefox special: Error configuring local description",a)})),this.sinch.mxp.configureMxpSession(this.callId,d.EncryptionKey,d.Body),c.resolve()}.bind(this)).fail(function(a){this.error=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,JSON.parse(a.response).message),this.callFailure(),c.reject(error)}.bind(this))}.bind(this),function(a){console.error("Failed to generate SDP Offer"),console.error(a)},{offerToReceiveAudio:!0,offerToReceiveVideo:this.videoSupport}),c.promise},Call.prototype.ackIncomingCall=function(a){var b=Q.defer();this.sinch.log(new Notification(0,1,"Incoming call",this)),setTimeout(function(){this.callState==CallState.INITIATING&&(this.sinch.log(new Notification(0,1,"Call PROGRESSING timeout. Will hangup call.",this)),this.setEndCause(CallEndCause.TIMEOUT),this.hangup())}.bind(this),TIMEOUT_CALLPROGRESSING),setTimeout(function(){this.callState==CallState.PROGRESSING&&(this.sinch.log(new Notification(0,1,"Call ESTABLISHED timeout. Will hangup call.",this)),this.setEndCause(CallEndCause.NO_ANSWER),this.hangup())}.bind(this),TIMEOUT_CALLESTABLISHED);var c=JSON.parse(a.decrypted.nvps.sdp);this.sinch.log(new Notification(0,1,"Received SDP offer from B",c));var d=new SessionDescription(c),e=this.initPC();return this.pcMap[a.getSenderId()]=e,this.pc=e,e.setRemoteDescription(d,function(){for(this.sinch.log(new Notification(1,3,"Successfully configured SDP Offer.",c));(this.iceMapRx[this.activeInstance]||[]).length;){var b=this.iceMapRx[this.activeInstance].pop();this.injectIce(a.getSenderId(),b),this.sinch.log(new Notification(0,1,"Injected ice from Ice Rx buffert",b))}e.createAnswer(function(b){e.setLocalDescription(b,function(){if(this.sinch.log(new Notification(2,3,"Successfully created SDP Answer.",b)),this.progress(!1),this.sinch.firefox){var c={candidate:"candidate:123123 1 UDP 1 127.0.0.1 3000 typ host",sdpMLI:0,sdpMLineIndex:0,sdpMid:"audio"};this.sinch.log(new Notification(0,1,"Firefox special: Will setup fake candidate injection interval.",c)),this.ffInjectCounter=0,this.ffIceTimer=setInterval(function(){this.sinch.log(new Notification(0,1,"Firefox special: Injecting fake candidate number: "+this.ffInjectCounter,c)),this.ffInjectCounter+=1,this.ffInjectCounter>2&&(this.sinch.log(new Notification(0,1,"Firefox special: Done injecting fake candidates.",this)),clearInterval(this.ffIceTimer)),this.pc.addIceCandidate(new IceCandidate(c),function(){},function(){})}.bind(this),15e3),this.pc.addIceCandidate(new IceCandidate(c),function(){},function(){})}if("yes"==a.decrypted.nvps.p2p)this.sinch.log(new Notification(2,3,"Header detected, p2p, will proceed with direct peer connection!.",a)),this.sinch.mxp.sendSdpAnswer(this,b).fail(function(){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending SDP Answer")});else{this.disableIce=!0,this.sinch.log(new Notification(2,3,"p2p header not detected, will fall back on proxy, we might deal with an old client",a)),this.mediaObj={callid:this.callId,proxyid:a.decrypted.bd.split("/")[2],sdp:b},this.sinch.mxp.sendSdpAnswer(this);var d=a.decrypted.bd.split("/")[3].split(":");e.proxyIce=e.proxyIce||[],e.proxyIce.push(new IceCandidate({sdpMid:"audio",sdpMLI:0,sdpMLineIndex:0,candidate:CallHelper.generateIceCandidate(d[0],d[1])}))}}.bind(this),function(a){console.error("Major error in setting local description",a)})}.bind(this),function(a){console.error("Major error in creating answer",a)})}.bind(this),function(a){throw setTimeout(function(){this.setEndCause(CallEndCause.FAILURE),this.error=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,a),this.sinch.mxp.callCancel(this).fail(function(){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Cancel")}),this.callFailure()}.bind(this),2e3),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error setting remote SDP")}.bind(this)),b.promise},Call.prototype.answer=function(){if(this.sinch.log(new Notification(0,1,"Answer call initiated, to answer()",this)),this.callState==CallState.PROGRESSING)this.mediaObj?this.sinch.postMedia(this.mediaObj).then(function(a){var b="audio:ISAC/0.0.0.0/"+a.proxyid+"/"+a.ip+":"+a.port;this.sinch.mxp.joinIncomingCall(this,b).then(function(){this.sinch.log(new Notification(3,3,"Successfully sent updated proxy information in Ack to caller",b))}.bind(this)).fail(function(a){throw console.error(a),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Could not send Ack to Old with MEDIA answer")})}.bind(this)).fail(function(a){throw console.error(a),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Could not send Answer to v1/media")}):this.sinch.mxp.joinIncomingCall(this).fail(function(){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending JOIN (pickup phone).")});else if("undefined"==typeof outgoingStream)this.sinch.log(new Notification(0,1,"Outgoing stream undefined, perhaps early answer. Will set auto answer for future automatic answer.")),this.autoAnswer=!0;else{if(this.callState==CallState.ENDED||this.callState==CallState.ESTABLISHED)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Call in invalid state to answer.");this.sinch.log(new Notification(0,1,"Stream defined and state in initializing or progressing. Setting auto answer for later retry.")),this.autoAnswer=!0}},Call.prototype.openDataChannel=function(a){return"undefined"==typeof this.dataChannels[a]&&(this.dataChannels[a]=this.pcMap[this.activeInstance].createDataChannel(a,{reliable:!1}),this.dataChannels[a].addEventListener=this.addEventListenerPrototype.bind(this.dataChannels[a]),this.execListener("onDataChannelAdded",this.dataChannels[a])),this.dataChannels[a]},Call.prototype.hangup=function(){if(this.hangupRetries=(this.hangupRetries||0)+1,this.callState==CallState.ESTABLISHED)this.sinch.mxp.callHangup(this).fail(function(){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Hangup")}),this.mxpHangup();else if(!this.callOutbound||this.callState!=CallState.PROGRESSING&&this.callState!=CallState.INITIATING)if(this.callOutbound||this.callState!=CallState.PROGRESSING&&this.callState!=CallState.INITIATING){if(this.callState==CallState.ENDED)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Call already ended");this.mxpHangup()}else this.callState==CallState.PROGRESSING?(this.sinch.mxp.callDeny(this).fail(function(){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Deny")}),this.setEndCause(CallEndCause.DENIED),this.mxpHangup()):this.autoHangup=!0;else Object.keys(this.clientMap).length>0||this.hangupRetries>5?(this.sinch.mxp.callCancel(this).fail(function(){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Cancel")}),this.mxpHangup()):(this.sinch.log(new Notification(0,1,"Can not hang up call at this time. Will try again in 0.5 seconds (max five retries).")),setTimeout(this.hangup.bind(this),500))},Call.prototype.getCallId=function(){return this.callId},Call.prototype.getDetails=function(){var a=new CallDetails({endCause:this.callEndCause,endedTime:this.timeEnded,error:this.error,establishedTime:this.timeEstablished,startedTime:this.timeProgressing,duration:this.timeEstablished?(this.timeEnded-this.timeEstablished)/1e3:0});return a},Call.prototype.getDirection=function(){return this.callOutbound?1:0},Call.prototype.getRemoteUserId=function(){return this.getDirection()?this.toId:this.fromId},Call.prototype.getState=function(){return Object.keys(CallState).filter(function(a){return CallState[a]===this.callState}.bind(this))[0]},Call.prototype.getEndCause=function(){return Object.keys(CallEndCause).filter(function(a){return CallEndCause[a]===this.callEndCause}.bind(this))[0]},Call.prototype.getHeaders=function(){return this.customHeaders},Call.prototype.sendDTMF=function(a){return this.DTMFsender||(this.DTMFsender=this.pc.createDTMFSender(this.outgoingStream.getAudioTracks()[0])),this.DTMFsender&&this.DTMFsender.insertDTMF(a)},Call.prototype.mute=function(){if(this.callState!=CallState.ESTABLISHED&&this.callState!=CallState.PROGRESSING&&this.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Call not in ESTABLISHED state.");this.sinch.log(new Notification(0,1,"Call was muted using mute()."));for(var a=this.outgoingStream.getAudioTracks(),b=0;b<a.length;b++)a[b].enabled=!1},Call.prototype.unmute=function(){if(this.callState!=CallState.ESTABLISHED&&this.callState!=CallState.PROGRESSING&&this.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Call not in ESTABLISHED state.");this.sinch.log(new Notification(0,1,"Call was un-muted using unmute()."));for(var a=this.outgoingStream.getAudioTracks(),b=0;b<a.length;b++)a[b].enabled=!0},navigator.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia,CallClient.prototype.addEventListener=function(a){this.eventListeners.push(a)},CallClient.prototype.removeEventListener=function(a){this.eventListeners.splice(this.eventListeners.indexOf(a),1)},CallClient.prototype.execListener=function(a,b){var c=0;return this.eventListeners.forEach(function(d){return c++,d[a]&&d[a](b)}.bind(this)),c},CallClient.prototype.initStream=function(a,b){var c=Q.defer(),d=this.sinch._supportVideo&&!b?{mandatory:{maxWidth:320,maxHeight:240}}:!1;return void 0!==a?(this.sinch.log(new Notification(0,1,"Will wire customStream into call",a)),c.resolve(a)):void 0===this.localMediaStream?(this.sinch.log(new Notification(0,1,"Will retrieve new Mic for stream")),navigator.getUserMedia({video:d,audio:!0},function(a){this.localMediaStream=a,c.resolve(this.localMediaStream)}.bind(this),function(a){console.error("Error retrieving media stream",a)})):(this.sinch.log(new Notification(0,1,"Will retrieve cached Mic for stream",this.localMediaStream)),c.resolve(this.localMediaStream)),c.promise},CallClient.prototype.alreadyInCall=function(){if(this.sinch._multiCall)return!1;for(var a in this.callBuffert)if(this.callBuffert[a].callState==CallState.PROGRESSING||this.callBuffert[a].callState==CallState.ESTABLISHED)return!0},CallClient.prototype.handleIncomingCall=function(a){this.sinch.log(new Notification(0,1,"Will handle incoming call",a));var b=new Call(this.sinch,this.sinch._supportVideo,a.mxpSessionId);b.callDomain=(a.decrypted.nvps||{}).nomedia?"connection":"data",b.setParticipants(a.decrypted.fu,this.sinch.user.userId),b.customHeaders=JSON.parse((a.decrypted.nvps||{}).ph||"{}"),this.sinch.mxp.configureMxpSession(b.callId,a.decrypted.nvps.key,a.decrypted.bd),b.clientMap[a.getSenderId()]=a.getFrom(),this.callBuffert[b.callId]=b,this.alreadyInCall()?(this.sinch.log(new Notification(0,1,"Already in a call, will hangup incoming call.",a)),this.sinch.mxp.subscribe("signalPubNub").then(function(){this.sinch.mxp.callDeny(b)}.bind(this))):this.execListener("onIncomingCall",b)?("connection"==b.callDomain?function(){var a=Q.defer();return a.resolve(null),a.promise}():this.initStream(this.incomingCallCustomStream)).then(function(c){return this.sinch.mxp.subscribe("signalPubNub").then(function(){(a.decrypted.nvps||{}).nomedia||b.setStream(c),b.activeInstance=a.getSenderId(),b.proxyUrl=a.decrypted.bd.replace(/(\r\n|\n|\r)/gm,""),b.ackIncomingCall(a).catch(function(a){console.error("Error handling incoming call",a)})}.bind(this))}.bind(this)):this.sinch.log(new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingCallback,"Missing handler, onIncomingCall."))},CallClient.prototype.callUser=function(a,b,c){this.sinch.log(new Notification(0,1,"CallUser method called",a));var d=new Call(this.sinch,this.sinch._supportVideo);return d.customHeaders=b,this.initStream(c).then(function(b){return this.sinch.mxp.subscribe("signalPubNub").then(function(){if(d.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error executing user call. Incorrect call state.");d.setStream(b),d.placeCall(a,"data"),this.callBuffert[d.callId]=d}.bind(this))}.bind(this)),d},CallClient.prototype.connect=function(a,b){this.sinch.log(new Notification(0,1,"connect method called",a));var c=new Call(this.sinch);return c.customHeaders=b,this.sinch.mxp.subscribe("signalPubNub").then(function(){if(c.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error executing connect. Incorrect call state.");c.placeCall(a,"connection"),this.callBuffert[c.callId]=c}.bind(this)),c},CallClient.prototype.callPhoneNumber=function(a,b,c){this.sinch.log(new Notification(0,1,"CallPhoneNumber method called",a));var d=new Call(this.sinch);return d.customHeaders=b,this.initStream(c,!0).then(function(b){return this.sinch.mxp.subscribe("signalPubNub").then(function(){if(d.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error executing user call. Incorrect call state.");d.setStream(b),d.placeCall(a,"pstn"),this.callBuffert[d.callId]=d}.bind(this))}.bind(this)),d},CallClient.prototype.callConference=function(a,b,c){if(this.sinch.log(new Notification(0,1,"CallConference method called",a)),a=""+a,!a||a.length>64)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Invalid conferenceId. Must be alphanumeric string less than 64 characters in length.");var d=new Call(this.sinch);return d.customHeaders=b,this.initStream(c,!0).then(function(b){return this.sinch.mxp.subscribe("signalPubNub").then(function(){if(d.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error executing user call. Incorrect call state.");d.setStream(b),d.placeCall(a,"conference"),this.callBuffert[d.callId]=d}.bind(this))}.bind(this)),d},CallClient.prototype.callGroup=function(a){if(this.sinch.log(new Notification(0,1,"callRoom method called, for group",a)),"undefined"!=typeof this.groupChannel)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Can not call room, already in a room");if(!this.sinch._multiCall)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Can not call room, multiCall capability not specified");return this.groupChannel=a,new GroupCall(this.sinch,a)};var CallState={INITIATING:0,PROGRESSING:1,ESTABLISHED:2,ENDED:3,TRANSFERRING:4},CallEndCause={NONE:0,TIMEOUT:1,CANCELED:6,DENIED:2,FAILURE:4,HUNG_UP:5,NO_ANSWER:3,OTHER_DEVICE_ANSWERED:7,TIMEOUT:1,TRANSFERRED:8},TIMEOUT_CALLPROGRESSING=10500,TIMEOUT_CALLESTABLISHED=45e3,CallHelper=function(){};CallHelper.generateIceCandidate=function(a,b){return"a=candidate:"+Math.random().toString(36).substring(5)+" 1 UDP 2130706431 "+a+" "+b+" typ relay\r\n"},GroupCall.prototype.addEventListener=function(a){this.eventListeners.push(a)},GroupCall.prototype.removeEventListener=function(a){this.eventListeners.splice(this.eventListeners.indexOf(a),1)},GroupCall.prototype.execListener=function(a,b){var c=0;return this.eventListeners.forEach(function(d){return c++,d[a]&&d[a](b)}.bind(this)),c},GroupCall.prototype.hangupGroup=function(){if("undefined"==typeof this.callClient.groupChannel)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Can not leave room, not in a room");for(var a in this.callBuffert)this.callBuffert[a].hangup();this.callClient.removeEventListener(this.groupListener),this.callClient.groupChannel=void 0},Message.prototype.getMXPMessageObj=function(){var a=new MXPMessageObj;return a.mxpSessionId=this.messageId,a.decrypted={bd:JSON.stringify({t:this.textBody})},this.headers&&(a.decrypted.nvps={ph:this.headers}),a.recipientIds=this.recipientIds,a},MessageClient.prototype.emptyLog=function(){this.logCounters={version:"2.0",sent:0,received:0,failed:0}},MessageClient.prototype.commitLog=function(){(this.logCounters.sent||this.logCounters.received||this.logCounters.failed)&&(this.sinch.log(new Notification(0,1,"Will post IM log to backend for statistics",this.logCounters)),this.sinch.messageReporting(this.logCounters).then(this.emptyLog.bind(this)))},MessageClient.prototype.destroy=function(){this.commitLog(),clearInterval(this.messageLogInterval)},MessageClient.prototype.handleMessage=function(a){a.recipientIds=a.transportObj.participants.reduce(function(a,b){return a.push(b.destination.identity),a}.bind(this),[]);var b,c=!1;return this.messageBuffert[a.mxpSessionId]?b=this.messageBuffert[a.mxpSessionId]:(b=new Message(a,a.decrypted.fu!=this.sinch.user.userId),this.messageBuffert[b.messageId]=b,c=!0),b.passedToHandler?!1:(this.eventListeners.forEach(function(a){return b.passedToHandler=!0,a.onIncomingMessage&&a.onIncomingMessage(b)}),c&&this.ackBuffert[b.messageId]&&(this.ackBuffert[b.messageId].forEach(function(a){this.ackMsg(a,b.messageId)}.bind(this)),delete this.ackBuffert[b.messageId]),b.direction||this.logCounters.received++,!0)},MessageClient.prototype.addEventListener=function(a){this.eventListeners.push(a)},MessageClient.prototype.removeEventListener=function(a){this.eventListeners.splice(this.eventListeners.indexOf(a),1)},MessageClient.prototype.send=function(a,b,c){var d=Q.defer();if(this.sinch.log(new Notification(0,1,"Send message method called"),d),!(a instanceof Message))throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Unsupported message parameters",a);return b=b||function(a){return a},c=c||function(a){console.error(a)},Q.fcall(function(a){if(void 0===this.sinch.mxp){var b=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKUnexpectedCall,"Sinch is not ready yet");throw d.reject(b),b}if(a.sent)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKUnexpectedCall,"Message already sent");return a.sent=!0,a}.bind(this),a).then(this.sinch.mxp.sendMessage.bind(this.sinch.mxp)).then(b).then(function(){this.logCounters.sent++}.bind(this)).then(d.resolve).fail(function(a){this.sinch.log(a),c(a),this.logCounters.failed++,d.reject(a)}.bind(this)).progress(function(a){this.sinch.log(a),d.notify(a)}.bind(this)),d.promise},MessageClient.prototype.ackMsg=function(a,b){this.messageBuffert[b]&&-1===this.messageBuffert[b].delivered.indexOf(a)?(this.sinch.log(new MXPLog("Recieved ack from "+a+" for message",b)),this.messageBuffert[b].delivered.push(a),this.eventListeners.forEach(function(c){return c.onMessageDelivered&&c.onMessageDelivered(new MessageDeliveryInfo(a,b))}.bind(this))):(this.ackBuffert[b]||(this.ackBuffert[b]=[]),this.ackBuffert[b].push(a),this.sinch.log(new MXPLog("Got ack for message with non-existing messageId, storing in ackBuffert",b)))},MessageClient.prototype.newMessage=function(a,b,c){if("string"==typeof a&&(a=[a]),"string"!=typeof b)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKUnexpectedCall,"Message text must be a string (for cross device compatability). Please stringify any objects.");if(c&&"string"!=typeof c)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKUnexpectedCall,"Headers must be a string (for cross device compatability). Please stringify any objects.");return new Message({recipientIds:a,textBody:b,senderId:this.sinch.user.userId,publicHeaders:c})},SinchError.prototype=Error.prototype,User.prototype.updateUser=function(a){var b=Q.defer();return this.sinch.updateUser(a).then(function(a){this.userObj=a,b.resolve(a)}.bind(this)).fail(function(a){b.reject(a)}.bind(this)),b.promise},User.prototype.create=function(a){var b=Q.defer(),c={password:a.password,identities:[]};return a.email&&(c.profile={contact:{email:a.email}},c.identities.push({type:"email",endpoint:a.email})),a.username&&c.identities.push({type:"username",endpoint:a.username}),a.number&&c.identities.push({type:"number",endpoint:a.number}),this.sinch.createUser(c).then(function(a){this.userObj=a,this.userId=a.user.identities.reduce(function(a,b){return"username"===b.type?b.endpoint:a+""},""),b.resolve(a)}.bind(this)).fail(function(a){b.reject(new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,a.data.errorCode+" "+a.data.message,a.data))}),b.promise},User.prototype.authenticate=function(a){if("object"!=typeof a)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,'No valid identity or authentication ticket. If you are passing your own authentication tickets, ensure it is an object on the format {"userTicket":SOME_TICKET}',a);if(a.expiresIn=a.expiresIn||86400,a.sessionId&&a.sessionSecret)return a;var b=Q.defer(),c="";if(this.sinch._appSecret)a=SinchTicketGenerator(this.sinch._appKey,this.sinch._appSecret,a);else if("email"in a){if(c=this.sinch.authenticate,""==a.email)return b.reject(new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Email is empty",a)),b.promise}else if("username"in a){if(c=this.sinch.authenticateUsername,""==a.username)return b.reject(new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Username is empty",a)),b.promise}else if("number"in a&&(c=this.sinch.authenticateNumber,""==a.number))return b.reject(new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Number is empty",a)),b.promise;if(a.authorization||a.userTicket){if(a.userTicket&&!a.user){var d=a.userTicket.split(":"),e=JSON.parse(atob(d[0]));"username"===!e.identity.type&&b.reject(new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Username missing in userTicket JSON object.",a)),a.user={identities:[e.identity]}}this.userObj=a,this.userObj.authorization=a.authorization||a.userTicket,this.userId=a.user.identities.reduce(function(a,b){return"username"===b.type?b.endpoint:a+""},""),b.resolve()}else c?c(a).then(function(a){this.userObj=a,this.userId=a.user.identities.reduce(function(a,b){return"username"===b.type?b.endpoint:a+""},""),b.resolve()}.bind(this)).fail(function(a){b.reject(new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,a.data.errorCode+" "+a.data.message,a.data))}):b.reject(new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"No valid identity or authentication ticket",a));return b.promise},User.prototype.initSessKeySecret=function(){var a=Q.defer(),b={};
b.version={os:getBrowserInfo()||"unknown",platform:getPlatformInfo()||"unknown",sdk:"js/"+this.sinch.getVersion()},b.services={calling:[]},this.sinch._onlineCapability&&b.services.calling.push("online"),this.sinch.capabilities.messaging&&b.services.calling.push("im"),this.sinch.capabilities.calling&&(b.services.calling.push("voip"),b.services.calling.push("p2p"),b.services.calling.push("srtp")),b.authorization=this.userObj.authorization;var c=""!==this.sinch._sessionId;return c&&(b.instanceId=this.sinch._sessionId),b.expiresIn=31536e3,this.sinch[c?"renewSecret":"getInstance"](b).then(function(b){this.sinch.config({sessionId:b.id,sessionSecret:b.secret}),a.resolve()}.bind(this)).fail(function(b){this.sinch._sessionId="",this.sinch._sessionSecret="",a.reject(new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,b.data.errorCode+" "+b.data.message,b.data))}.bind(this)),a.promise},User.prototype.resumeSession=function(a){var b=Q.defer();return this.userId=a.userId,this.sinch.config(a),this.sinch.getUserProfile().then(function(a){this.userObj=a,b.resolve()}.bind(this)).fail(function(a){b.reject(a instanceof SinchError?a:new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,a.data.errorCode+" "+a.data.message,a.data))}),b.promise},User.prototype.getMXPConf=function(){var a=Q.defer();return this.sinch.getConfiguration().then(function(b){this.mxpConfig=b,a.resolve()}.bind(this)).fail(function(b){a.reject(new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,b.data.errorCode+" "+b.data.message,b.data))}),a.promise},Verification.prototype.request=function(a,b){var c=Q.defer();if(this.flagVerified){var d=new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationUnexpectedInitiateError,"Verification already verified, can't request new code.");c.reject(d)}else{var e={identity:{type:"number",endpoint:this.number},custom:this.custom,method:"sms",metadata:{os:getBrowserInfo(),platform:getPlatformInfo(),sdk:"js/"+this.sinch.getVersion()}};this.sinch.verifyUserSMS(e).then(function(){a&&a(),c.resolve()}.bind(this)).fail(function(a){var d;d=a.status?new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationServiceError,"Could not request verification: "+a.statusText,a.responseText):a,b&&b(d),c.reject(d)}.bind(this))}return c.promise},Verification.prototype.verify=function(a,b,c){var d=Q.defer();if(this.flagVerified)b&&b(this.cachedResponse),d.resolve(this.cachedResponse);else{var e={number:this.number,source:"manual",sms:{code:a},method:"sms"};this.sinch.confirmUserSMS(e).then(function(a){this.flagVerified=!0,this.cachedResponse=a,b&&b(a),d.resolve(a)}.bind(this)).fail(function(a){var b;b=a.status?new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationIncorrectCode,"Could not verify code: "+a.statusText,a.responseText):a,c&&c(b),d.reject(b)}.bind(this))}return d.promise},Verification.prototype.initiate=function(a,b){return this.request(a,b)},Verification.prototype.retry=function(a,b){return this.request(a,b)},MXP.prototype.init=function(){return this.subscribe("broadcastPubNub")},MXP.prototype.close=function(){var a=this.broadcastPubNub,b=this.signalPubNub;return setTimeout(function(){a&&a.offline(),b&&b.offline()}.bind(this),1e4),Q.all([this.unsubscribe("broadcastPubNub"),this.unsubscribe("signalPubNub")])},MXP.prototype.destroy=function(){delete this.broadcastPubNub,delete this.signalPubNub},MXP.prototype.subscribe=function(a){var b=Q.defer(),c={restore:!1,connect:function(){b.resolve()}.bind(this),channel:Object.keys(this[a].sinchStack),callback:this._onmessagePubNub.bind(this),disconnect:this._ondisconnectPubNub.bind(this),error:this._onerrorPubNub.bind(this)},d=!0;for(var e in this[a].sinchStack)d&=0==this[a].sinchStack[e].length,this[a].sinchStack[e].push(!0);return d?this[a].subscribe(c):b.resolve(),b.promise},MXP.prototype.subscribeNotificationChannel=function(a){var b=Q.defer(),c="broadcastPubNub";this[c].sinchStack[a]=[];var d={restore:!1,connect:function(){b.resolve()}.bind(this),channel:a,callback:function(b){this.sinch.onnotification(a,b)}.bind(this),disconnect:this._ondisconnectPubNub.bind(this),error:this._onerrorPubNub.bind(this)};return this[c].subscribe(d),b.promise},MXP.prototype.unsubscribe=function(a){var b=!0;for(var c in this[a].sinchStack)this[a].sinchStack[c].pop(),b&=0==this[a].sinchStack[c].length;b&&this[a].unsubscribe({channel:Object.keys(this[a].sinchStack)})},MXP.prototype.signalStatus=function(){return this.signalPubNub.sinchStack[this.rtcProfile.signalChannel].length>0},MXP.prototype._onmessagePubNub=function(a){this.sinch.log(new MXPLog("Recieved message",a)),Q.fcall(this.collectFrames.bind(this),a).then(this.identifyKey.bind(this)).then(MXPdecrypt).then(this.handleMessage.bind(this)).fail(function(b){if(b instanceof MXPCryptError){var c=a.split(" ")[1];this.unencryptedFrames[c]=this.unencryptedFrames[c]||[],this.unencryptedFrames[c].push(b.response.message)}else this.handleError(b)}.bind(this))},MXP.prototype.configureMxpSession=function(a,b,c){this.sessionBuffert[a]={key:b,body:c},this.processUnencryptedForKey(a)},MXP.prototype.processUnencryptedForKey=function(a){for(var b in this.unencryptedFrames[a])this._onmessagePubNub(this.unencryptedFrames[a][b]),delete this.unencryptedFrames[a][b]},MXP.prototype._ondisconnectPubNub=function(a){this.sinch.log(new MXPLog("Was disconnected!",a))},MXP.prototype._onerrorPubNub=function(a){var b=new MXPError(ErrorDomain.ErrorDomainNetwork,ErrorCode.NetworkConnectionRefused,"PubNub error",a);this.sinch.log(b)},MXP.prototype.collectFrames=function(a){var b=Q.defer(),c=a.split(" "),d=c[1]+c[2];try{c[3]=parseInt(c[3]),c[4]=parseInt(c[4])}catch(e){console.error("Could not parse MXP indices. Malformatted MXP message.")}if(1===c[4])b.resolve(a);else if((this.messageBuffert[d]||(this.messageBuffert[d]={}))[c[3]]=c[5],Object.keys(this.messageBuffert[d]).length==c[4]){var f=c[0]+" "+c[1]+" "+c[2]+" 0 1 ";for(var g in this.messageBuffert[d])f+=this.messageBuffert[d][g];void 0!==c[6]&&(f+=" "+c[6]),this.sinch.log(new MXPLog("All frames collected and merged, full array",this.messageBuffert[d])),delete this.messageBuffert[d],b.resolve(f)}else b.reject(new MXPLog("All frames not yet gathered",this.messageBuffert[d]));return b.promise},MXP.prototype.identifyKey=function(a){this.sinch.log(new MXPLog("Will identify key",a));var b,c=Q.defer(),d=a.trim().split(" ");return void 0!==(b=d[6])?(this.sinch.log(new MXPLog("Transport key identified",a)),this.getTransport(b).then(function(e){c.resolve(new MXPMessageObj({mxpSessionId:d[1],message:a,transportId:b,transportObj:e,key:this.transportBuffert[b].key,keyType:"T"}))}.bind(this)).fail(function(a){c.reject(a)}.bind(this))):void 0!==(this.sessionBuffert[d[1]]||{}).key?(this.sinch.log(new MXPLog("Session key in buffert identified",a)),c.resolve(new MXPMessageObj({mxpSessionId:d[1],message:a,key:this.sessionBuffert[d[1]].key,keyType:"S"}))):(this.sinch.log(new MXPLog("No key, fall back on instance key",a)),c.resolve(new MXPMessageObj({mxpSessionId:d[1],message:a,key:this.rtcProfile.key,keyType:"I"}))),c.promise},MXP.prototype.handleMessage=function(a){this.sinch.log(new MXPLog("Will handle message",a));var b=Q.defer(),c=a.decrypted.md+"_"+(a.decrypted.bt||"null");return this.sinch.logMxp(new MXPIncoming(c,a)),MXPHandlers[c]?MXPHandlers[c].call(this,a):b.reject(new MXPError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"Handler not implemented: "+c,{})),b.promise},MXP.prototype.handleError=function(a){this.sinch.log(a),a.stack&&console.error(a.stack)},MXP.prototype.getTransport=function(a){var b=Q.defer();if(a.constructor==String){var c=a;void 0!==this.transportBuffert[c]?(this.sinch.log(new MXPLog("Got transport from Buffert",this.transportBuffert[c])),b.resolve(this.transportBuffert[c])):this.sinch.getTransportById({transportId:c}).then(function(a){this.sinch.log(new MXPLog("Got new transport",a)),this.transportBuffert[c]=a,b.resolve(this.transportBuffert[c])}.bind(this))}else{if(a instanceof MXPMessageObj||a instanceof Array){var d=a instanceof MXPMessageObj?a.recipientIds:a;d=d.filter(function(a,b,c){return c.indexOf(a)===b});var e=d.indexOf(this.user.userId);e>-1&&d.splice(e,1);var f=[];d.forEach(function(a){if("string"==typeof a)f.push({identity:a});else if(a instanceof Object){for(var b in a)f.push({identity:a[b],type:b})}}),d.push(this.user.userId),d=d.sort();var g=btoa(JSON.stringify(d));if(this.transportBuffert[g]){var h=this.transportBuffert[g];this.sinch.log(new MXPLog("Got cached transport for recipient(s)",h)),a instanceof MXPMessageObj?(a.transportObj=h,a.transportId=a.transportObj.transportId,b.resolve(a)):b.resolve(h)}else this.sinch.getTransportByParticipants(f).then(function(c){c.participants.forEach(function(a){a.capabilityUnion=[],(a.instances||[]).forEach(function(b){a.capabilityUnion=a.capabilityUnion.concat(b.capabilities)}),a.capabilityUnion=a.capabilityUnion.filter(function(b,c){return a.capabilityUnion.indexOf(b)==c})});var e=[];if(c.participants.forEach(function(a){-1===a.capabilityUnion.indexOf("im")&&-1===a.capabilityUnion.indexOf("im.1")&&e.push(a.destination.identity)}),e.length>0)throw new SinchError(ErrorDomain.ErrorDomainCapability,ErrorCode.CapabilityCapabilityMissing,"User missing capability",e);c.participants.unshift({channel:this.rtcProfile.transportChannel,destination:{identity:this.user.userId}});var f=c.participants.reduce(function(a,b){return a.push(b.destination.identity),a}.bind(this),[]),h=d.filter(function(a){return f.indexOf(a)<0});if(d.length!=c.participants.length)throw new MXPError(ErrorDomain.ErrorDomainCapability,ErrorCode.CapabilityUserNotFound,"User does not exist",h);this.sinch.log(new MXPLog("Got new transport for recipient(s)",c)),this.transportBuffert[g]=c,a instanceof MXPMessageObj?(a.transportObj=c,a.transportId=a.transportObj.transportId,b.resolve(a)):b.resolve(c)}.bind(this)).fail(function(a){b.reject(a)});return b.promise}b.reject(new MXPError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"Unknown transport ID",c))}return b.promise},MXP.prototype.sendMXP=function(a){var b=Q.defer();return a.sub=a.sub||"broadcastPubNub",Q.fcall(this.constructMXP.bind(this),a).then(this.identifyEnKey.bind(this)).then(MXPencrypt).then(this.splitFrames.bind(this)).then(this.getTxChannels.bind(this)).then(this.transmitFrames.bind(this)).then(function(a){b.resolve(a)}).fail(function(a){console.error(a.stack),console.error(a),b.reject(a)}).progress(function(a){b.notify(a)}),b.promise},MXP.prototype.constructMXP=function(a){return a.decrypted.fu=this.user.userId,a.decrypted.fi=this.sinch._sessionId+":"+this.sinch._subInstanceId,a.decrypted.fd=this.sinch._sessionId,a.decrypted.fc="",this.sinch.log(new MXPLog("Added meta data to MXP message",a)),a},MXP.prototype.identifyEnKey=function(a){return a.transportObj?(a.transportId=a.transportObj.transportId,a.key=a.transportObj.key,a.keyType="T",a.decrypted.fs=this.rtcProfile.transportChannel):(a.key=this.sessionBuffert[a.mxpSessionId].key,a.keyType="S",a.decrypted.fs=this.rtcProfile.signalChannel),this.sinch.log(new MXPLog("Identified Encoding Key",a)),a},MXP.prototype.splitFrames=function(a){a.encodedFrames=[];var b=1500;b-=a.mxpSessionId.length,b-=(a.transportId||"").length,b-=9,b-=6;do a.encodedFrames.push(a.encrypted.slice(0,b)),a.encrypted=a.encrypted.substring(b);while(a.encrypted.length>0);var c=Math.floor(2e9*Math.random());for(var d in a.encodedFrames)a.encodedFrames[d]="10 "+a.mxpSessionId+" "+(a.encodedFrames.length>1?c:"-")+" "+d+" "+a.encodedFrames.length+" "+a.encodedFrames[d],a.transportId&&(a.encodedFrames[d]+=" "+a.transportId);return this.sinch.log(new MXPLog("Split message into frames as needed",a)),a},MXP.prototype.getTxChannels=function(a){return a.txChannels=a.txChannels||[],a.transportObj&&a.transportObj.participants.forEach(function(b){a.txChannels.push(b.channel)}),this.sinch.log(new MXPLog("Identified Tx Channels",a)),a},MXP.prototype.transmitFrames=function(a){var b=Q.defer();this.sinch.logMxp(new MXPOutgoing(a.decrypted.md+"_"+(a.decrypted.bt||"null"),a));var c,d=[];return c=a.transportObj?a.transportObj.participants.length*a.encodedFrames.length:a.encodedFrames.length,d.length==c&&b.resolve(a),a.txChannels.forEach(function(e){a.encodedFrames.forEach(function(f){this.sinch.log(new MXPLog("Transmitting [channel, frame]",[e,f])),this[a.sub].publish({channel:e,message:f,callback:function(e){d.push(e),b.notify(new Notification(d.length,c,"MXP Message send progress (frame Tx)")),d.length==c&&setTimeout(function(){b.resolve(a)},1e3)},error:function(a){console.error("PubNub: Error sending frame",a),b.reject(new MXPError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"PubNub: Error sending frame",a))}})}.bind(this))}.bind(this)),b.promise},MXPError.prototype=Error.prototype;var MXPCallingVersion=10;MXP.prototype.joinIncomingCall=function(a,b){var c=Q.defer(),d=new MXPMessageObj({mxpSessionId:a.callId},a);return d.decrypted.bd=b||null,d.decrypted.md=3,d.decrypted.bt=b?"media":"sdp",d.decrypted.bv=MXPCallingVersion,this.sendMXP(d).then(function(){c.resolve()}).fail(function(a){c.reject(a)}).progress(function(a){c.notify(a)}.bind(this)),c.promise},MXP.prototype.callJoined=function(a){var b=Q.defer(),c=new MXPMessageObj({mxpSessionId:a.callId},a);return c.decrypted.bd=JSON.stringify(a.clientMap[a.activeInstance]),c.decrypted.md=4,c.decrypted.bt="client",c.decrypted.bv=MXPCallingVersion,delete c.decrypted.nvps.to,this.sendMXP(c).then(function(){b.resolve()}).fail(function(a){b.reject(a)}).progress(function(a){b.notify(a)}.bind(this)),b.promise},MXP.prototype.sendSdpAnswer=function(a,b){var c=Q.defer(),d=new MXPMessageObj({mxpSessionId:a.callId},a);return d.decrypted.bd=b?JSON.stringify(b):null,d.decrypted.md=2,d.decrypted.bt=b?"sdp":null,d.decrypted.bv=MXPCallingVersion,this.sendMXP(d).then(function(){c.resolve()}).fail(function(a){c.reject(a)}).progress(function(a){c.notify(a)}.bind(this)),c.promise},MXP.prototype.callHangup=function(a){var b=Q.defer(),c=new MXPMessageObj({mxpSessionId:a.callId},a);return c.decrypted.md=5,c.decrypted.bv=MXPCallingVersion,this.sendMXP(c).then(function(){b.resolve()}).fail(function(a){b.reject(a)}).progress(function(a){b.notify(a)}.bind(this)),b.promise},MXP.prototype.callDeny=function(a){var b=Q.defer(),c=new MXPMessageObj({mxpSessionId:a.callId},a);return c.decrypted.md=6,c.decrypted.bv=MXPCallingVersion,this.sendMXP(c).then(function(){b.resolve()}).fail(function(a){b.reject(a)}).progress(function(a){b.notify(a)}.bind(this)),b.promise},MXP.prototype.callCancel=function(a){var b=Q.defer(),c=new MXPMessageObj({mxpSessionId:a.callId},a);return c.decrypted.md=7,c.decrypted.bv=MXPCallingVersion,this.sendMXP(c).then(function(){b.resolve()}).fail(function(a){b.reject(a)}).progress(function(a){b.notify(a)}.bind(this)),b.promise},MXP.prototype.callTxICECandidate=function(a,b,c){var d=Q.defer(),e=new MXPMessageObj({mxpSessionId:a.callId},a);return e.decrypted.bd=JSON.stringify(b),e.decrypted.md=10,e.decrypted.bt="sdp",e.decrypted.bv=MXPCallingVersion,c&&(e.decrypted.nvps=e.decrypted.nvps||{},e.decrypted.nvps.to=c||"undefined"),this.sendMXP(e).then(function(){d.resolve()}).fail(function(a){d.reject(a)}).progress(function(a){d.notify(a)}.bind(this)),d.promise},MXP.prototype.callTxPeerEventSDP=function(a,b,c){var d=Q.defer(),e=new MXPMessageObj({mxpSessionId:a.callId},a);return e.decrypted.bd=JSON.stringify(b),e.decrypted.md=10,e.decrypted.bt="sdp",e.decrypted.bv=MXPCallingVersion,e.decrypted.nvps=e.decrypted.nvps||{},e.decrypted.nvps.to=c||"undefined",this.sendMXP(e).then(function(){d.resolve()}).fail(function(a){d.reject(a)}).progress(function(a){d.notify(a)}.bind(this)),d.promise},MXP.prototype.msgToMe=function(a){return!a.decrypted.nvps||!a.decrypted.nvps.to||a.decrypted.nvps.to==this.sinch._sessionId+":"+this.sinch._subInstanceId},MXP.prototype.msgToMe2=function(a){return!a.decrypted.nvps||!a.decrypted.nvps.to||a.decrypted.nvps.to==this.sinch._sessionId};var verifyCallingCapability=function(){if("undefined"==typeof this.sinch.callClient){var a=new MXPError(ErrorDomain.ErrorDomainCapability,ErrorCode.CapabilityCapabilityMissing,"Can not process call signal messages. Call capability not set.");this.sinch.log(a)}},MXPCallHandlers={"1_media":function(a){this.msgToMe2(a)?(verifyCallingCapability.call(this),this.sinch.callClient&&this.sinch.callClient.handleIncomingCall(a)):this.sinch.log(new Notification(0,1,"Received INVITE message not meant for this instance, nvps.to header set to foreign instance id",a))},"2_media":function(a){this.sinch.callClient&&this.sinch.callClient.callBuffert[a.mxpSessionId]&&this.sinch.callClient.callBuffert[a.mxpSessionId].mxpAck(a)},"2_sdp":function(a){this.sinch.callClient&&this.sinch.callClient.callBuffert[a.mxpSessionId]&&this.sinch.callClient.callBuffert[a.mxpSessionId].mxpAck(a)},"3_media":function(a){this.sinch.callClient&&this.sinch.callClient.callBuffert[a.mxpSessionId]&&this.sinch.callClient.callBuffert[a.mxpSessionId].mxpJoin(a)},"3_sdp":function(a){this.sinch.callClient&&this.sinch.callClient.callBuffert[a.mxpSessionId]&&this.sinch.callClient.callBuffert[a.mxpSessionId].mxpJoin(a)},"4_client":function(a){this.sinch.callClient&&this.sinch.callClient.callBuffert[a.mxpSessionId]&&this.sinch.callClient.callBuffert[a.mxpSessionId].mxpJoined(a)},"5_null":function(a){this.msgToMe(a)?this.sinch.callClient&&this.sinch.callClient.callBuffert[a.mxpSessionId]&&this.sinch.callClient.callBuffert[a.mxpSessionId].mxpHangup(a):this.sinch.log(new Notification(0,1,"Received HUNG_UP message not meant for this instance, nvps.to header set to foreign instance id",a))},"6_null":function(a){this.msgToMe(a)?this.sinch.callClient&&this.sinch.callClient.callBuffert[a.mxpSessionId]&&this.sinch.callClient.callBuffert[a.mxpSessionId].mxpDeny(a):this.sinch.callClient&&this.sinch.log(new Notification(0,1,"Received DENIED message not meant for this instance, nvps.to header set to foreign instance id",a))},"7_null":function(a){this.msgToMe(a)?this.sinch.callClient&&this.sinch.callClient.callBuffert[a.mxpSessionId]&&this.sinch.callClient.callBuffert[a.mxpSessionId].mxpCancel(a):this.sinch.log(new Notification(0,1,"Received CANCEL message not meant for this instance, nvps.to header set to foreign instance id",a))},"7_client":function(a){this.msgToMe(a)?this.sinch.callClient&&this.sinch.callClient.callBuffert[a.mxpSessionId]&&this.sinch.callClient.callBuffert[a.mxpSessionId].mxpCancel(a):this.sinch.log(new Notification(0,1,"Received CANCEL message not meant for this instance, nvps.to header set to foreign instance id",a))},"9_message":function(a){this.sinch.callClient&&this.sinch.callClient.callBuffert[a.mxpSessionId]&&this.sinch.callClient.callBuffert[a.mxpSessionId].mxpFail(a)},"10_sdp":function(a){if(this.msgToMe(a)){var b=JSON.parse(a.decrypted.bd);"type"in b?this.sinch.callClient&&this.sinch.callClient.callBuffert[a.mxpSessionId]&&this.sinch.callClient.callBuffert[a.mxpSessionId].mxpPeerEventSdp(a):this.sinch.callClient&&this.sinch.callClient.callBuffert[a.mxpSessionId]&&this.sinch.callClient.callBuffert[a.mxpSessionId].mxpInjectIce(a)}else this.sinch.log(new Notification(0,1,"Received SDP/CAND message not meant for this instance, nvps.to header set to foreign instance id",a))}},MXPHandlers=MXPHandlers||{};for(var key in MXPCallHandlers)MXPHandlers[key]=MXPCallHandlers[key];var MXPMessagingVersion=10;MXP.prototype.sendMessage=function(a){var b=a.getMXPMessageObj(),c=Q.defer();return b.decrypted.md=1,b.decrypted.bt="msg",b.decrypted.bv=MXPMessagingVersion,this.getTransport(b).then(this.sendMXP.bind(this)).then(function(a){MXPHandlers["1_msg"].call(this,a),this.sinch.log(new MXPLog("Message sent to all participants",a)),c.resolve(this.sinch.messageClient.messageBuffert[a.mxpSessionId])}.bind(this)).fail(function(a){c.reject(a)}).progress(function(a){c.notify(a)}.bind(this)),c.promise},MXP.prototype.sendMsgAck=function(a){var b=new MXPMessageObj({mxpSessionId:a.mxpSessionId});b.decrypted.md=2,b.decrypted.bt=a.decrypted.bt,b.decrypted.bv=MXPMessagingVersion,b.transportObj=a.transportObj;var c=[];b.transportObj.participants.forEach(function(b){b.channel==a.decrypted.fs&&c.push(b)}.bind(this)),b.transportObj.participants=c,Object.keys(b.transportObj.participants).length>0&&(this.sinch.log(new MXPLog("Will send Ack",b)),this.sendMXP(b).then(function(b){this.sinch.log(new MXPLog("Sent ack",[a.decrypted.fu,b.channel]))}.bind(this)).fail(function(a){console.error(a)}))};var verifyMessagingCapability=function(){if("undefined"==typeof this.sinch.messageClient){var a=new MXPError(ErrorDomain.ErrorDomainCapability,ErrorCode.CapabilityCapabilityMissing,"Can not process IM messages. Messaging capability not set.");this.sinch.log(a)}},MXPIMHandlers={none:function(a){console.log("Null handler for message object: ",a)},"1_msg":function(a){verifyMessagingCapability.call(this);var b=this.sinch.messageClient&&this.sinch.messageClient.handleMessage(a);b&&a.decrypted.fu!=this.user.userId&&this.sendMsgAck(a)},"2_msg":function(a){this.sinch.messageClient&&this.sinch.messageClient.ackMsg(a.decrypted.fu,a.mxpSessionId)}},MXPHandlers=MXPHandlers||{};for(var key in MXPIMHandlers)MXPHandlers[key]=MXPIMHandlers[key];MXPMessageObj.prototype.getSenderId=function(){if("undefined"==typeof this.decrypted.fi)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalError,"getSenderId failed, no from instance defined",{});return this.decrypted.fsi?this.decrypted.fi+this.decrypted.fsi||"virtual":(this.decrypted.nvps||{}).fsi?this.decrypted.fi+this.decrypted.nvps.fsi||"virtual":this.decrypted.fi||"virtual"},MXPMessageObj.prototype.getFrom=function(){return{fc:this.decrypted.fc,fd:this.decrypted.fd,fi:this.decrypted.fi,fsi:this.decrypted.fsi,fs:this.decrypted.fs,fu:this.decrypted.fu}};var MXPencrypt=function(a){{var b=a.key,c=a.decrypted;a.mxpSessionId}try{var d=CryptoJS.enc.Utf8.parse(JSON.stringify(c));b=CryptoJS.enc.Base64.parse(b);var e=CryptoJS.lib.WordArray.random(16),f=CryptoJS.AES.encrypt(d,b,{iv:e}),g=CryptoJS.enc.Hex.parse(e.toString(CryptoJS.enc.Hex)+f.ciphertext.toString(CryptoJS.enc.Hex))}catch(h){throw h.message=a.message,new MXPCryptError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"MXPEncrypt error: "+h.message,h)}return a.encrypted=g.toString(CryptoJS.enc.Base64),a},MXPdecrypt=function(a){try{var b=a.key,c=a.message,d=c.split(" ")[5],e=CryptoJS.enc.Base64.parse(d),f=e.toString(CryptoJS.enc.Hex),g=CryptoJS.enc.Hex.parse(f.substr(0,32)),h=CryptoJS.enc.Hex.parse(f.substr(32)),i=CryptoJS.lib.CipherParams.create({ciphertext:h,salt:null}),j=CryptoJS.AES.decrypt(i,CryptoJS.enc.Base64.parse(b),{iv:g}),k=j.toString(CryptoJS.enc.Utf8),l=k.indexOf("{"),m=k.lastIndexOf("}")+1;k=k.substring(l,m),a.decrypted=JSON.parse(k)}catch(n){throw n.message=a.message,new MXPCryptError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"MXPDecrypt error: "+n.message,n)}return a},CryptoJS=CryptoJS||function(a,b){var c={},d=c.lib={},e=function(){},f=d.Base={extend:function(a){e.prototype=this;var b=new e;return a&&b.mixIn(a),b.hasOwnProperty("init")||(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},g=d.WordArray=f.extend({init:function(a,c){a=this.words=a||[],this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||i).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes;if(a=a.sigBytes,this.clamp(),d%4)for(var e=0;a>e;e++)b[d+e>>>2]|=(c[e>>>2]>>>24-8*(e%4)&255)<<24-8*((d+e)%4);else if(65535<c.length)for(e=0;a>e;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-8*(c%4),b.length=a.ceil(c/4)},clone:function(){var a=f.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],d=0;b>d;d+=4)c.push(4294967296*a.random()|0);return new g.init(c,b)}}),h=c.enc={},i=h.Hex={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++){var e=b[d>>>2]>>>24-8*(d%4)&255;c.push((e>>>4).toString(16)),c.push((15&e).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return new g.init(c,b/2)}},j=h.Latin1={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-8*(d%4)&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-8*(d%4);return new g.init(c,b)}},k=h.Utf8={stringify:function(a){try{return decodeURIComponent(escape(j.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return j.parse(unescape(encodeURIComponent(a)))}},l=d.BufferedBlockAlgorithm=f.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=k.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,f=this.blockSize,h=e/(4*f),h=b?a.ceil(h):a.max((0|h)-this._minBufferSize,0);if(b=h*f,e=a.min(4*b,e),b){for(var i=0;b>i;i+=f)this._doProcessBlock(d,i);i=d.splice(0,b),c.sigBytes-=e}return new g.init(i,e)},clone:function(){var a=f.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});d.Hasher=l.extend({cfg:f.extend(),init:function(a){this.cfg=this.cfg.extend(a),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,c){return new a.init(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return new m.HMAC.init(a,c).finalize(b)}}});var m=c.algo={};return c}(Math);!function(a){function b(a,b,c,d,e,f,g){return a=a+(b&c|~b&d)+e+g,(a<<f|a>>>32-f)+b}function c(a,b,c,d,e,f,g){return a=a+(b&d|c&~d)+e+g,(a<<f|a>>>32-f)+b}function d(a,b,c,d,e,f,g){return a=a+(b^c^d)+e+g,(a<<f|a>>>32-f)+b}function e(a,b,c,d,e,f,g){return a=a+(c^(b|~d))+e+g,(a<<f|a>>>32-f)+b}for(var f=CryptoJS,g=f.lib,h=g.WordArray,i=g.Hasher,g=f.algo,j=[],k=0;64>k;k++)j[k]=4294967296*a.abs(a.sin(k+1))|0;g=g.MD5=i.extend({_doReset:function(){this._hash=new h.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(a,f){for(var g=0;16>g;g++){var h=f+g,i=a[h];a[h]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8)}var g=this._hash.words,h=a[f+0],i=a[f+1],k=a[f+2],l=a[f+3],m=a[f+4],n=a[f+5],o=a[f+6],p=a[f+7],q=a[f+8],r=a[f+9],s=a[f+10],t=a[f+11],u=a[f+12],v=a[f+13],w=a[f+14],x=a[f+15],y=g[0],z=g[1],A=g[2],B=g[3],y=b(y,z,A,B,h,7,j[0]),B=b(B,y,z,A,i,12,j[1]),A=b(A,B,y,z,k,17,j[2]),z=b(z,A,B,y,l,22,j[3]),y=b(y,z,A,B,m,7,j[4]),B=b(B,y,z,A,n,12,j[5]),A=b(A,B,y,z,o,17,j[6]),z=b(z,A,B,y,p,22,j[7]),y=b(y,z,A,B,q,7,j[8]),B=b(B,y,z,A,r,12,j[9]),A=b(A,B,y,z,s,17,j[10]),z=b(z,A,B,y,t,22,j[11]),y=b(y,z,A,B,u,7,j[12]),B=b(B,y,z,A,v,12,j[13]),A=b(A,B,y,z,w,17,j[14]),z=b(z,A,B,y,x,22,j[15]),y=c(y,z,A,B,i,5,j[16]),B=c(B,y,z,A,o,9,j[17]),A=c(A,B,y,z,t,14,j[18]),z=c(z,A,B,y,h,20,j[19]),y=c(y,z,A,B,n,5,j[20]),B=c(B,y,z,A,s,9,j[21]),A=c(A,B,y,z,x,14,j[22]),z=c(z,A,B,y,m,20,j[23]),y=c(y,z,A,B,r,5,j[24]),B=c(B,y,z,A,w,9,j[25]),A=c(A,B,y,z,l,14,j[26]),z=c(z,A,B,y,q,20,j[27]),y=c(y,z,A,B,v,5,j[28]),B=c(B,y,z,A,k,9,j[29]),A=c(A,B,y,z,p,14,j[30]),z=c(z,A,B,y,u,20,j[31]),y=d(y,z,A,B,n,4,j[32]),B=d(B,y,z,A,q,11,j[33]),A=d(A,B,y,z,t,16,j[34]),z=d(z,A,B,y,w,23,j[35]),y=d(y,z,A,B,i,4,j[36]),B=d(B,y,z,A,m,11,j[37]),A=d(A,B,y,z,p,16,j[38]),z=d(z,A,B,y,s,23,j[39]),y=d(y,z,A,B,v,4,j[40]),B=d(B,y,z,A,h,11,j[41]),A=d(A,B,y,z,l,16,j[42]),z=d(z,A,B,y,o,23,j[43]),y=d(y,z,A,B,r,4,j[44]),B=d(B,y,z,A,u,11,j[45]),A=d(A,B,y,z,x,16,j[46]),z=d(z,A,B,y,k,23,j[47]),y=e(y,z,A,B,h,6,j[48]),B=e(B,y,z,A,p,10,j[49]),A=e(A,B,y,z,w,15,j[50]),z=e(z,A,B,y,n,21,j[51]),y=e(y,z,A,B,u,6,j[52]),B=e(B,y,z,A,l,10,j[53]),A=e(A,B,y,z,s,15,j[54]),z=e(z,A,B,y,i,21,j[55]),y=e(y,z,A,B,q,6,j[56]),B=e(B,y,z,A,x,10,j[57]),A=e(A,B,y,z,o,15,j[58]),z=e(z,A,B,y,v,21,j[59]),y=e(y,z,A,B,m,6,j[60]),B=e(B,y,z,A,t,10,j[61]),A=e(A,B,y,z,k,15,j[62]),z=e(z,A,B,y,r,21,j[63]);g[0]=g[0]+y|0,g[1]=g[1]+z|0,g[2]=g[2]+A|0,g[3]=g[3]+B|0},_doFinalize:function(){var b=this._data,c=b.words,d=8*this._nDataBytes,e=8*b.sigBytes;c[e>>>5]|=128<<24-e%32;var f=a.floor(d/4294967296);for(c[(e+64>>>9<<4)+15]=16711935&(f<<8|f>>>24)|4278255360&(f<<24|f>>>8),c[(e+64>>>9<<4)+14]=16711935&(d<<8|d>>>24)|4278255360&(d<<24|d>>>8),b.sigBytes=4*(c.length+1),this._process(),b=this._hash,c=b.words,d=0;4>d;d++)e=c[d],c[d]=16711935&(e<<8|e>>>24)|4278255360&(e<<24|e>>>8);return b},clone:function(){var a=i.clone.call(this);return a._hash=this._hash.clone(),a}}),f.MD5=i._createHelper(g),f.HmacMD5=i._createHmacHelper(g)}(Math);var CryptoJS=CryptoJS||function(a,b){var c={},d=c.lib={},e=function(){},f=d.Base={extend:function(a){e.prototype=this;var b=new e;return a&&b.mixIn(a),b.hasOwnProperty("init")||(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},g=d.WordArray=f.extend({init:function(a,c){a=this.words=a||[],this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||i).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes;if(a=a.sigBytes,this.clamp(),d%4)for(var e=0;a>e;e++)b[d+e>>>2]|=(c[e>>>2]>>>24-8*(e%4)&255)<<24-8*((d+e)%4);else if(65535<c.length)for(e=0;a>e;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-8*(c%4),b.length=a.ceil(c/4)},clone:function(){var a=f.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],d=0;b>d;d+=4)c.push(4294967296*a.random()|0);return new g.init(c,b)}}),h=c.enc={},i=h.Hex={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++){var e=b[d>>>2]>>>24-8*(d%4)&255;c.push((e>>>4).toString(16)),c.push((15&e).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return new g.init(c,b/2)}},j=h.Latin1={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-8*(d%4)&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-8*(d%4);return new g.init(c,b)}},k=h.Utf8={stringify:function(a){try{return decodeURIComponent(escape(j.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return j.parse(unescape(encodeURIComponent(a)))}},l=d.BufferedBlockAlgorithm=f.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=k.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,f=this.blockSize,h=e/(4*f),h=b?a.ceil(h):a.max((0|h)-this._minBufferSize,0);if(b=h*f,e=a.min(4*b,e),b){for(var i=0;b>i;i+=f)this._doProcessBlock(d,i);i=d.splice(0,b),c.sigBytes-=e}return new g.init(i,e)},clone:function(){var a=f.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});d.Hasher=l.extend({cfg:f.extend(),init:function(a){this.cfg=this.cfg.extend(a),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,c){return new a.init(c).finalize(b)
}},_createHmacHelper:function(a){return function(b,c){return new m.HMAC.init(a,c).finalize(b)}}});var m=c.algo={};return c}(Math);!function(a){for(var b=CryptoJS,c=b.lib,d=c.WordArray,e=c.Hasher,c=b.algo,f=[],g=[],h=function(a){return 4294967296*(a-(0|a))|0},i=2,j=0;64>j;){var k;a:{k=i;for(var l=a.sqrt(k),m=2;l>=m;m++)if(!(k%m)){k=!1;break a}k=!0}k&&(8>j&&(f[j]=h(a.pow(i,.5))),g[j]=h(a.pow(i,1/3)),j++),i++}var n=[],c=c.SHA256=e.extend({_doReset:function(){this._hash=new d.init(f.slice(0))},_doProcessBlock:function(a,b){for(var c=this._hash.words,d=c[0],e=c[1],f=c[2],h=c[3],i=c[4],j=c[5],k=c[6],l=c[7],m=0;64>m;m++){if(16>m)n[m]=0|a[b+m];else{var o=n[m-15],p=n[m-2];n[m]=((o<<25|o>>>7)^(o<<14|o>>>18)^o>>>3)+n[m-7]+((p<<15|p>>>17)^(p<<13|p>>>19)^p>>>10)+n[m-16]}o=l+((i<<26|i>>>6)^(i<<21|i>>>11)^(i<<7|i>>>25))+(i&j^~i&k)+g[m]+n[m],p=((d<<30|d>>>2)^(d<<19|d>>>13)^(d<<10|d>>>22))+(d&e^d&f^e&f),l=k,k=j,j=i,i=h+o|0,h=f,f=e,e=d,d=o+p|0}c[0]=c[0]+d|0,c[1]=c[1]+e|0,c[2]=c[2]+f|0,c[3]=c[3]+h|0,c[4]=c[4]+i|0,c[5]=c[5]+j|0,c[6]=c[6]+k|0,c[7]=c[7]+l|0},_doFinalize:function(){var b=this._data,c=b.words,d=8*this._nDataBytes,e=8*b.sigBytes;return c[e>>>5]|=128<<24-e%32,c[(e+64>>>9<<4)+14]=a.floor(d/4294967296),c[(e+64>>>9<<4)+15]=d,b.sigBytes=4*c.length,this._process(),this._hash},clone:function(){var a=e.clone.call(this);return a._hash=this._hash.clone(),a}});b.SHA256=e._createHelper(c),b.HmacSHA256=e._createHmacHelper(c)}(Math),function(){var a=CryptoJS,b=a.enc.Utf8;a.algo.HMAC=a.lib.Base.extend({init:function(a,c){a=this._hasher=new a.init,"string"==typeof c&&(c=b.parse(c));var d=a.blockSize,e=4*d;c.sigBytes>e&&(c=a.finalize(c)),c.clamp();for(var f=this._oKey=c.clone(),g=this._iKey=c.clone(),h=f.words,i=g.words,j=0;d>j;j++)h[j]^=1549556828,i[j]^=909522486;f.sigBytes=g.sigBytes=e,this.reset()},reset:function(){var a=this._hasher;a.reset(),a.update(this._iKey)},update:function(a){return this._hasher.update(a),this},finalize:function(a){var b=this._hasher;return a=b.finalize(a),b.reset(),b.finalize(this._oKey.clone().concat(a))}})}(),function(){var a=CryptoJS,b=a.lib.WordArray;a.enc.Base64={stringify:function(a){var b=a.words,c=a.sigBytes,d=this._map;a.clamp(),a=[];for(var e=0;c>e;e+=3)for(var f=(b[e>>>2]>>>24-8*(e%4)&255)<<16|(b[e+1>>>2]>>>24-8*((e+1)%4)&255)<<8|b[e+2>>>2]>>>24-8*((e+2)%4)&255,g=0;4>g&&c>e+.75*g;g++)a.push(d.charAt(f>>>6*(3-g)&63));if(b=d.charAt(64))for(;a.length%4;)a.push(b);return a.join("")},parse:function(a){var c=a.length,d=this._map,e=d.charAt(64);e&&(e=a.indexOf(e),-1!=e&&(c=e));for(var e=[],f=0,g=0;c>g;g++)if(g%4){var h=d.indexOf(a.charAt(g-1))<<2*(g%4),i=d.indexOf(a.charAt(g))>>>6-2*(g%4);e[f>>>2]|=(h|i)<<24-8*(f%4),f++}return b.create(e,f)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}();var CryptoJS=CryptoJS||function(a,b){var c={},d=c.lib={},e=function(){},f=d.Base={extend:function(a){e.prototype=this;var b=new e;return a&&b.mixIn(a),b.hasOwnProperty("init")||(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},g=d.WordArray=f.extend({init:function(a,c){a=this.words=a||[],this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||i).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes;if(a=a.sigBytes,this.clamp(),d%4)for(var e=0;a>e;e++)b[d+e>>>2]|=(c[e>>>2]>>>24-8*(e%4)&255)<<24-8*((d+e)%4);else if(65535<c.length)for(e=0;a>e;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-8*(c%4),b.length=a.ceil(c/4)},clone:function(){var a=f.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],d=0;b>d;d+=4)c.push(4294967296*a.random()|0);return new g.init(c,b)}}),h=c.enc={},i=h.Hex={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++){var e=b[d>>>2]>>>24-8*(d%4)&255;c.push((e>>>4).toString(16)),c.push((15&e).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return new g.init(c,b/2)}},j=h.Latin1={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-8*(d%4)&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-8*(d%4);return new g.init(c,b)}},k=h.Utf8={stringify:function(a){try{return decodeURIComponent(escape(j.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return j.parse(unescape(encodeURIComponent(a)))}},l=d.BufferedBlockAlgorithm=f.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=k.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,f=this.blockSize,h=e/(4*f),h=b?a.ceil(h):a.max((0|h)-this._minBufferSize,0);if(b=h*f,e=a.min(4*b,e),b){for(var i=0;b>i;i+=f)this._doProcessBlock(d,i);i=d.splice(0,b),c.sigBytes-=e}return new g.init(i,e)},clone:function(){var a=f.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});d.Hasher=l.extend({cfg:f.extend(),init:function(a){this.cfg=this.cfg.extend(a),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,c){return new a.init(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return new m.HMAC.init(a,c).finalize(b)}}});var m=c.algo={};return c}(Math);!function(){var a=CryptoJS,b=a.lib.WordArray;a.enc.Base64={stringify:function(a){var b=a.words,c=a.sigBytes,d=this._map;a.clamp(),a=[];for(var e=0;c>e;e+=3)for(var f=(b[e>>>2]>>>24-8*(e%4)&255)<<16|(b[e+1>>>2]>>>24-8*((e+1)%4)&255)<<8|b[e+2>>>2]>>>24-8*((e+2)%4)&255,g=0;4>g&&c>e+.75*g;g++)a.push(d.charAt(f>>>6*(3-g)&63));if(b=d.charAt(64))for(;a.length%4;)a.push(b);return a.join("")},parse:function(a){var c=a.length,d=this._map,e=d.charAt(64);e&&(e=a.indexOf(e),-1!=e&&(c=e));for(var e=[],f=0,g=0;c>g;g++)if(g%4){var h=d.indexOf(a.charAt(g-1))<<2*(g%4),i=d.indexOf(a.charAt(g))>>>6-2*(g%4);e[f>>>2]|=(h|i)<<24-8*(f%4),f++}return b.create(e,f)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(a){function b(a,b,c,d,e,f,g){return a=a+(b&c|~b&d)+e+g,(a<<f|a>>>32-f)+b}function c(a,b,c,d,e,f,g){return a=a+(b&d|c&~d)+e+g,(a<<f|a>>>32-f)+b}function d(a,b,c,d,e,f,g){return a=a+(b^c^d)+e+g,(a<<f|a>>>32-f)+b}function e(a,b,c,d,e,f,g){return a=a+(c^(b|~d))+e+g,(a<<f|a>>>32-f)+b}for(var f=CryptoJS,g=f.lib,h=g.WordArray,i=g.Hasher,g=f.algo,j=[],k=0;64>k;k++)j[k]=4294967296*a.abs(a.sin(k+1))|0;g=g.MD5=i.extend({_doReset:function(){this._hash=new h.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(a,f){for(var g=0;16>g;g++){var h=f+g,i=a[h];a[h]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8)}var g=this._hash.words,h=a[f+0],i=a[f+1],k=a[f+2],l=a[f+3],m=a[f+4],n=a[f+5],o=a[f+6],p=a[f+7],q=a[f+8],r=a[f+9],s=a[f+10],t=a[f+11],u=a[f+12],v=a[f+13],w=a[f+14],x=a[f+15],y=g[0],z=g[1],A=g[2],B=g[3],y=b(y,z,A,B,h,7,j[0]),B=b(B,y,z,A,i,12,j[1]),A=b(A,B,y,z,k,17,j[2]),z=b(z,A,B,y,l,22,j[3]),y=b(y,z,A,B,m,7,j[4]),B=b(B,y,z,A,n,12,j[5]),A=b(A,B,y,z,o,17,j[6]),z=b(z,A,B,y,p,22,j[7]),y=b(y,z,A,B,q,7,j[8]),B=b(B,y,z,A,r,12,j[9]),A=b(A,B,y,z,s,17,j[10]),z=b(z,A,B,y,t,22,j[11]),y=b(y,z,A,B,u,7,j[12]),B=b(B,y,z,A,v,12,j[13]),A=b(A,B,y,z,w,17,j[14]),z=b(z,A,B,y,x,22,j[15]),y=c(y,z,A,B,i,5,j[16]),B=c(B,y,z,A,o,9,j[17]),A=c(A,B,y,z,t,14,j[18]),z=c(z,A,B,y,h,20,j[19]),y=c(y,z,A,B,n,5,j[20]),B=c(B,y,z,A,s,9,j[21]),A=c(A,B,y,z,x,14,j[22]),z=c(z,A,B,y,m,20,j[23]),y=c(y,z,A,B,r,5,j[24]),B=c(B,y,z,A,w,9,j[25]),A=c(A,B,y,z,l,14,j[26]),z=c(z,A,B,y,q,20,j[27]),y=c(y,z,A,B,v,5,j[28]),B=c(B,y,z,A,k,9,j[29]),A=c(A,B,y,z,p,14,j[30]),z=c(z,A,B,y,u,20,j[31]),y=d(y,z,A,B,n,4,j[32]),B=d(B,y,z,A,q,11,j[33]),A=d(A,B,y,z,t,16,j[34]),z=d(z,A,B,y,w,23,j[35]),y=d(y,z,A,B,i,4,j[36]),B=d(B,y,z,A,m,11,j[37]),A=d(A,B,y,z,p,16,j[38]),z=d(z,A,B,y,s,23,j[39]),y=d(y,z,A,B,v,4,j[40]),B=d(B,y,z,A,h,11,j[41]),A=d(A,B,y,z,l,16,j[42]),z=d(z,A,B,y,o,23,j[43]),y=d(y,z,A,B,r,4,j[44]),B=d(B,y,z,A,u,11,j[45]),A=d(A,B,y,z,x,16,j[46]),z=d(z,A,B,y,k,23,j[47]),y=e(y,z,A,B,h,6,j[48]),B=e(B,y,z,A,p,10,j[49]),A=e(A,B,y,z,w,15,j[50]),z=e(z,A,B,y,n,21,j[51]),y=e(y,z,A,B,u,6,j[52]),B=e(B,y,z,A,l,10,j[53]),A=e(A,B,y,z,s,15,j[54]),z=e(z,A,B,y,i,21,j[55]),y=e(y,z,A,B,q,6,j[56]),B=e(B,y,z,A,x,10,j[57]),A=e(A,B,y,z,o,15,j[58]),z=e(z,A,B,y,v,21,j[59]),y=e(y,z,A,B,m,6,j[60]),B=e(B,y,z,A,t,10,j[61]),A=e(A,B,y,z,k,15,j[62]),z=e(z,A,B,y,r,21,j[63]);g[0]=g[0]+y|0,g[1]=g[1]+z|0,g[2]=g[2]+A|0,g[3]=g[3]+B|0},_doFinalize:function(){var b=this._data,c=b.words,d=8*this._nDataBytes,e=8*b.sigBytes;c[e>>>5]|=128<<24-e%32;var f=a.floor(d/4294967296);for(c[(e+64>>>9<<4)+15]=16711935&(f<<8|f>>>24)|4278255360&(f<<24|f>>>8),c[(e+64>>>9<<4)+14]=16711935&(d<<8|d>>>24)|4278255360&(d<<24|d>>>8),b.sigBytes=4*(c.length+1),this._process(),b=this._hash,c=b.words,d=0;4>d;d++)e=c[d],c[d]=16711935&(e<<8|e>>>24)|4278255360&(e<<24|e>>>8);return b},clone:function(){var a=i.clone.call(this);return a._hash=this._hash.clone(),a}}),f.MD5=i._createHelper(g),f.HmacMD5=i._createHmacHelper(g)}(Math),function(){var a=CryptoJS,b=a.lib,c=b.Base,d=b.WordArray,b=a.algo,e=b.EvpKDF=c.extend({cfg:c.extend({keySize:4,hasher:b.MD5,iterations:1}),init:function(a){this.cfg=this.cfg.extend(a)},compute:function(a,b){for(var c=this.cfg,e=c.hasher.create(),f=d.create(),g=f.words,h=c.keySize,c=c.iterations;g.length<h;){i&&e.update(i);var i=e.update(a).finalize(b);e.reset();for(var j=1;c>j;j++)i=e.finalize(i),e.reset();f.concat(i)}return f.sigBytes=4*h,f}});a.EvpKDF=function(a,b,c){return e.create(c).compute(a,b)}}(),CryptoJS.lib.Cipher||function(a){var b=CryptoJS,c=b.lib,d=c.Base,e=c.WordArray,f=c.BufferedBlockAlgorithm,g=b.enc.Base64,h=b.algo.EvpKDF,i=c.Cipher=f.extend({cfg:d.extend(),createEncryptor:function(a,b){return this.create(this._ENC_XFORM_MODE,a,b)},createDecryptor:function(a,b){return this.create(this._DEC_XFORM_MODE,a,b)},init:function(a,b,c){this.cfg=this.cfg.extend(c),this._xformMode=a,this._key=b,this.reset()},reset:function(){f.reset.call(this),this._doReset()},process:function(a){return this._append(a),this._process()},finalize:function(a){return a&&this._append(a),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(a){return{encrypt:function(b,c,d){return("string"==typeof c?o:n).encrypt(a,b,c,d)},decrypt:function(b,c,d){return("string"==typeof c?o:n).decrypt(a,b,c,d)}}}});c.StreamCipher=i.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var j=b.mode={},k=function(b,c,d){var e=this._iv;e?this._iv=a:e=this._prevBlock;for(var f=0;d>f;f++)b[c+f]^=e[f]},l=(c.BlockCipherMode=d.extend({createEncryptor:function(a,b){return this.Encryptor.create(a,b)},createDecryptor:function(a,b){return this.Decryptor.create(a,b)},init:function(a,b){this._cipher=a,this._iv=b}})).extend();l.Encryptor=l.extend({processBlock:function(a,b){var c=this._cipher,d=c.blockSize;k.call(this,a,b,d),c.encryptBlock(a,b),this._prevBlock=a.slice(b,b+d)}}),l.Decryptor=l.extend({processBlock:function(a,b){var c=this._cipher,d=c.blockSize,e=a.slice(b,b+d);c.decryptBlock(a,b),k.call(this,a,b,d),this._prevBlock=e}}),j=j.CBC=l,l=(b.pad={}).Pkcs7={pad:function(a,b){for(var c=4*b,c=c-a.sigBytes%c,d=c<<24|c<<16|c<<8|c,f=[],g=0;c>g;g+=4)f.push(d);c=e.create(f,c),a.concat(c)},unpad:function(a){a.sigBytes-=255&a.words[a.sigBytes-1>>>2]}},c.BlockCipher=i.extend({cfg:i.cfg.extend({mode:j,padding:l}),reset:function(){i.reset.call(this);var a=this.cfg,b=a.iv,a=a.mode;if(this._xformMode==this._ENC_XFORM_MODE)var c=a.createEncryptor;else c=a.createDecryptor,this._minBufferSize=1;this._mode=c.call(a,this,b&&b.words)},_doProcessBlock:function(a,b){this._mode.processBlock(a,b)},_doFinalize:function(){var a=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){a.pad(this._data,this.blockSize);var b=this._process(!0)}else b=this._process(!0),a.unpad(b);return b},blockSize:4});var m=c.CipherParams=d.extend({init:function(a){this.mixIn(a)},toString:function(a){return(a||this.formatter).stringify(this)}}),j=(b.format={}).OpenSSL={stringify:function(a){var b=a.ciphertext;return a=a.salt,(a?e.create([1398893684,1701076831]).concat(a).concat(b):b).toString(g)},parse:function(a){a=g.parse(a);var b=a.words;if(1398893684==b[0]&&1701076831==b[1]){var c=e.create(b.slice(2,4));b.splice(0,4),a.sigBytes-=16}return m.create({ciphertext:a,salt:c})}},n=c.SerializableCipher=d.extend({cfg:d.extend({format:j}),encrypt:function(a,b,c,d){d=this.cfg.extend(d);var e=a.createEncryptor(c,d);return b=e.finalize(b),e=e.cfg,m.create({ciphertext:b,key:c,iv:e.iv,algorithm:a,mode:e.mode,padding:e.padding,blockSize:a.blockSize,formatter:d.format})},decrypt:function(a,b,c,d){return d=this.cfg.extend(d),b=this._parse(b,d.format),a.createDecryptor(c,d).finalize(b.ciphertext)},_parse:function(a,b){return"string"==typeof a?b.parse(a,this):a}}),b=(b.kdf={}).OpenSSL={execute:function(a,b,c,d){return d||(d=e.random(8)),a=h.create({keySize:b+c}).compute(a,d),c=e.create(a.words.slice(b),4*c),a.sigBytes=4*b,m.create({key:a,iv:c,salt:d})}},o=c.PasswordBasedCipher=n.extend({cfg:n.cfg.extend({kdf:b}),encrypt:function(a,b,c,d){return d=this.cfg.extend(d),c=d.kdf.execute(c,a.keySize,a.ivSize),d.iv=c.iv,a=n.encrypt.call(this,a,b,c.key,d),a.mixIn(c),a},decrypt:function(a,b,c,d){return d=this.cfg.extend(d),b=this._parse(b,d.format),c=d.kdf.execute(c,a.keySize,a.ivSize,b.salt),d.iv=c.iv,n.decrypt.call(this,a,b,c.key,d)}})}(),function(){for(var a=CryptoJS,b=a.lib.BlockCipher,c=a.algo,d=[],e=[],f=[],g=[],h=[],i=[],j=[],k=[],l=[],m=[],n=[],o=0;256>o;o++)n[o]=128>o?o<<1:o<<1^283;for(var p=0,q=0,o=0;256>o;o++){var r=q^q<<1^q<<2^q<<3^q<<4,r=r>>>8^255&r^99;d[p]=r,e[r]=p;var s=n[p],t=n[s],u=n[t],v=257*n[r]^16843008*r;f[p]=v<<24|v>>>8,g[p]=v<<16|v>>>16,h[p]=v<<8|v>>>24,i[p]=v,v=16843009*u^65537*t^257*s^16843008*p,j[r]=v<<24|v>>>8,k[r]=v<<16|v>>>16,l[r]=v<<8|v>>>24,m[r]=v,p?(p=s^n[n[n[u^s]]],q^=n[n[q]]):p=q=1}var w=[0,1,2,4,8,16,32,64,128,27,54],c=c.AES=b.extend({_doReset:function(){for(var a=this._key,b=a.words,c=a.sigBytes/4,a=4*((this._nRounds=c+6)+1),e=this._keySchedule=[],f=0;a>f;f++)if(c>f)e[f]=b[f];else{var g=e[f-1];f%c?c>6&&4==f%c&&(g=d[g>>>24]<<24|d[g>>>16&255]<<16|d[g>>>8&255]<<8|d[255&g]):(g=g<<8|g>>>24,g=d[g>>>24]<<24|d[g>>>16&255]<<16|d[g>>>8&255]<<8|d[255&g],g^=w[f/c|0]<<24),e[f]=e[f-c]^g}for(b=this._invKeySchedule=[],c=0;a>c;c++)f=a-c,g=c%4?e[f]:e[f-4],b[c]=4>c||4>=f?g:j[d[g>>>24]]^k[d[g>>>16&255]]^l[d[g>>>8&255]]^m[d[255&g]]},encryptBlock:function(a,b){this._doCryptBlock(a,b,this._keySchedule,f,g,h,i,d)},decryptBlock:function(a,b){var c=a[b+1];a[b+1]=a[b+3],a[b+3]=c,this._doCryptBlock(a,b,this._invKeySchedule,j,k,l,m,e),c=a[b+1],a[b+1]=a[b+3],a[b+3]=c},_doCryptBlock:function(a,b,c,d,e,f,g,h){for(var i=this._nRounds,j=a[b]^c[0],k=a[b+1]^c[1],l=a[b+2]^c[2],m=a[b+3]^c[3],n=4,o=1;i>o;o++)var p=d[j>>>24]^e[k>>>16&255]^f[l>>>8&255]^g[255&m]^c[n++],q=d[k>>>24]^e[l>>>16&255]^f[m>>>8&255]^g[255&j]^c[n++],r=d[l>>>24]^e[m>>>16&255]^f[j>>>8&255]^g[255&k]^c[n++],m=d[m>>>24]^e[j>>>16&255]^f[k>>>8&255]^g[255&l]^c[n++],j=p,k=q,l=r;p=(h[j>>>24]<<24|h[k>>>16&255]<<16|h[l>>>8&255]<<8|h[255&m])^c[n++],q=(h[k>>>24]<<24|h[l>>>16&255]<<16|h[m>>>8&255]<<8|h[255&j])^c[n++],r=(h[l>>>24]<<24|h[m>>>16&255]<<16|h[j>>>8&255]<<8|h[255&k])^c[n++],m=(h[m>>>24]<<24|h[j>>>16&255]<<16|h[k>>>8&255]<<8|h[255&l])^c[n++],a[b]=p,a[b+1]=q,a[b+2]=r,a[b+3]=m},keySize:8});a.AES=b._createHelper(c)}(),module.exports=Sinch,module.exports.MessageClient=MessageClient,module.exports.Message=Message,module.exports.Call=Call,module.exports.CallClient=CallClient,module.exports.Verification=Verification,module.exports.CallDetails=CallDetails,module.exports.MessageDeliveryInfo=MessageDeliveryInfo,module.exports.PAPIDefs=PAPI;